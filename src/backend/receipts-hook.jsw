/**
 * Receipts Database Hook - Standalone Module
 * Provides functions to manage receipts in the Receipts collection
 * 
 * Functions:
 * - saveReceipt(email, paymentData, receiptEmail, emailResult, isGPTGenerated) → Save receipt to database
 * - getReceipt(receiptId) → Get receipt by ID
 * - getReceiptsByEmail(email) → Get all receipts for an email
 * - getReceiptsBySubmissionId(submissionId) → Get receipt for a submission
 * - resendReceipt(receiptId) → Resend a receipt email
 * 
 * IMPORTANT: This is a .jsw file - HTTP-accessible via /_functions/receipts-hook/[function-name]
 * Permissions: Anyone (for public access, but should be restricted in production)
 */

import wixData from 'wix-data';
import { sendEmail } from 'backend/mission-support-middleware';

/**
 * Save receipt to database
 * Called automatically by sendPaymentReceiptEmail hook
 * @public
 * @param {string} email - Recipient email
 * @param {Object} paymentData - Complete payment data
 * @param {Object} receiptEmail - Generated email content
 * @param {Object} emailResult - Email sending result
 * @param {boolean} isGPTGenerated - Whether receipt was GPT-generated
 */
export async function saveReceipt(email, paymentData, receiptEmail, emailResult, isGPTGenerated) {
    try {
        const receiptId = 'receipt_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
        const timestamp = new Date();
        
        // Generate receipt number
        const receiptNumber = paymentData._id || 'MS-' + Date.now();
        
        // Prepare receipt record
        const receiptRecord = {
            _id: receiptId,
            receiptNumber: receiptNumber,
            recipientEmail: email,
            recipientName: `${paymentData.firstName} ${paymentData.lastName}`,
            firstName: paymentData.firstName,
            lastName: paymentData.lastName,
            address: paymentData.address,
            missionSupportName: paymentData.missionSupportName || null,
            amount: paymentData.amount,
            currency: paymentData.currency || 'USD',
            paymentMethod: paymentData.paymentMethod || 'card',
            paymentStatus: paymentData.paymentStatus || 'pending',
            transactionId: paymentData.paymentResult?.sessionId || paymentData.paymentResult?.invoiceId || null,
            invoiceId: paymentData.paymentResult?.invoiceId || null,
            source: paymentData.source || 'mission_support_form',
            emailSubject: receiptEmail.subject,
            emailHtml: receiptEmail.html,
            emailText: receiptEmail.text,
            isGPTGenerated: isGPTGenerated,
            emailSent: emailResult.success || false,
            emailSentAt: emailResult.success ? timestamp : null,
            emailError: emailResult.error || null,
            submissionId: paymentData._id || null,
            created_at: timestamp,
            metadata: {
                paymentData: {
                    paymentMethod: paymentData.paymentMethod,
                    paymentResult: paymentData.paymentResult,
                    created_at: paymentData.created_at
                },
                emailService: emailResult.service || 'unknown',
                gptModel: isGPTGenerated ? 'gpt-4-turbo-preview' : null,
                templateVersion: isGPTGenerated ? null : 'v1.0'
            }
        };
        
        // Save to Receipts collection
        await wixData.save('Receipts', receiptRecord);
        console.log('✅ Receipt saved to database:', receiptId);
        
        return {
            success: true,
            receiptId: receiptId,
            receiptNumber: receiptNumber
        };
        
    } catch (error) {
        console.error('❌ Error saving receipt to database:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Get receipt by ID
 * @public
 * @param {string} receiptId - Receipt ID
 */
export async function getReceipt(receiptId) {
    try {
        const receipt = await wixData.get('Receipts', receiptId);
        
        return {
            success: true,
            receipt: receipt
        };
    } catch (error) {
        console.error('❌ Error getting receipt:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Get all receipts for an email address
 * @public
 * @param {string} email - Email address
 */
export async function getReceiptsByEmail(email) {
    try {
        const receipts = await wixData.query('Receipts')
            .eq('recipientEmail', email.toLowerCase())
            .descending('created_at')
            .find();
        
        return {
            success: true,
            receipts: receipts.items,
            count: receipts.items.length
        };
    } catch (error) {
        console.error('❌ Error getting receipts by email:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Get receipt for a submission
 * @public
 * @param {string} submissionId - Submission ID
 */
export async function getReceiptsBySubmissionId(submissionId) {
    try {
        const receipts = await wixData.query('Receipts')
            .eq('submissionId', submissionId)
            .descending('created_at')
            .find();
        
        return {
            success: true,
            receipts: receipts.items,
            count: receipts.items.length
        };
    } catch (error) {
        console.error('❌ Error getting receipts by submission ID:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Resend receipt email
 * @public
 * @param {string} receiptId - Receipt ID
 */
export async function resendReceipt(receiptId) {
    try {
        // Get receipt from database
        const receipt = await wixData.get('Receipts', receiptId);
        
        if (!receipt) {
            throw new Error('Receipt not found');
        }
        
        // Resend email
        const emailResult = await sendEmail(
            receipt.recipientEmail,
            receipt.emailSubject,
            receipt.emailHtml,
            receipt.emailText
        );
        
        // Update receipt record
        if (emailResult.success) {
            await wixData.update('Receipts', {
                ...receipt,
                emailSent: true,
                emailSentAt: new Date(),
                emailError: null,
                metadata: {
                    ...receipt.metadata,
                    resent: true,
                    resentAt: new Date()
                }
            });
        } else {
            await wixData.update('Receipts', {
                ...receipt,
                emailError: emailResult.error,
                metadata: {
                    ...receipt.metadata,
                    resendAttempts: (receipt.metadata.resendAttempts || 0) + 1,
                    lastResendAttempt: new Date()
                }
            });
        }
        
        return {
            success: emailResult.success,
            receiptId: receiptId,
            emailResult: emailResult
        };
        
    } catch (error) {
        console.error('❌ Error resending receipt:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Get receipt statistics
 * @public
 */
export async function getReceiptStatistics() {
    try {
        // Get all receipts
        const allReceipts = await wixData.query('Receipts')
            .find();
        
        const total = allReceipts.items.length;
        const sent = allReceipts.items.filter(r => r.emailSent).length;
        const failed = allReceipts.items.filter(r => !r.emailSent).length;
        const gptGenerated = allReceipts.items.filter(r => r.isGPTGenerated).length;
        const templateBased = allReceipts.items.filter(r => !r.isGPTGenerated).length;
        
        // Calculate total amount
        const totalAmount = allReceipts.items.reduce((sum, receipt) => {
            return sum + (receipt.amount || 0);
        }, 0);
        
        return {
            success: true,
            statistics: {
                total: total,
                sent: sent,
                failed: failed,
                gptGenerated: gptGenerated,
                templateBased: templateBased,
                totalAmount: totalAmount,
                sendRate: total > 0 ? (sent / total * 100).toFixed(2) + '%' : '0%',
                gptRate: total > 0 ? (gptGenerated / total * 100).toFixed(2) + '%' : '0%'
            }
        };
    } catch (error) {
        console.error('❌ Error getting receipt statistics:', error);
        return {
            success: false,
            error: error.message
        };
    }
}
