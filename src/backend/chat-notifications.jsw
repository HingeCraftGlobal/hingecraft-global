/**
 * Chat Notifications - Wix Velo Backend Module
 * Handles live chat notifications to marketing email when users ask questions
 * 
 * Functions:
 * - notifyMarketingOnQuestion(chatMessage, userInfo) ‚Üí Send notification to marketing email
 * - saveChatMessage(chatMessage, userInfo) ‚Üí Save chat message to database
 * - getChatHistory(userId) ‚Üí Get chat history for a user
 * - analyzeChatIntent(message) ‚Üí Use GPT to analyze chat intent and route appropriately
 * 
 * IMPORTANT: This is a .jsw file - HTTP-accessible via /_functions/chat-notifications/[function-name]
 * Permissions: Anyone (for public access)
 */

import wixData from 'wix-data';
import { secrets } from 'wix-secrets-backend';
import { fetch } from 'wix-fetch';

/**
 * Notify marketing email when user asks a question in live chat
 * Analyzes message with GPT to determine if it needs human response
 * @public
 * @param {Object} chatData - Chat message data
 * @param {string} chatData.message - Chat message text
 * @param {string} chatData.userId - User ID
 * @param {string} chatData.userEmail - User email (if available)
 * @param {string} chatData.userName - User name (if available)
 * @param {string} chatData.sessionId - Session ID
 * @param {string} chatData.pageUrl - Page URL
 */
export async function notifyMarketingOnQuestion(chatData) {
    try {
        console.log('üí¨ Chat question received:', chatData);
        
        // Analyze message with GPT to determine if it needs human response
        const intentAnalysis = await analyzeChatIntent(chatData.message);
        
        // Only notify if it's a question that needs human response
        if (!intentAnalysis.needsHumanResponse) {
            console.log('‚ÑπÔ∏è Message does not require human response, skipping notification');
            return {
                success: true,
                notified: false,
                reason: 'Auto-handled by system'
            };
        }
        
        // Save chat message to database
        try {
            await saveChatMessage(chatData, intentAnalysis);
        } catch (dbError) {
            console.warn('‚ö†Ô∏è Error saving chat message (non-blocking):', dbError);
        }
        
        // Get marketing email from secrets
        let marketingEmail;
        try {
            marketingEmail = await secrets.getSecret('MARKETING_EMAIL');
        } catch (e) {
            // Fallback to default
            marketingEmail = 'marketing@hingecraft-global.ai';
            console.warn('‚ö†Ô∏è MARKETING_EMAIL not found in secrets, using default');
        }
        
        // Generate notification email
        const notificationEmail = await generateMarketingNotificationEmail(chatData, intentAnalysis);
        
        // Send notification email
        const emailResult = await sendNotificationEmail(marketingEmail, notificationEmail);
        
        return {
            success: true,
            notified: true,
            marketingEmail: marketingEmail,
            intentAnalysis: intentAnalysis,
            emailResult: emailResult
        };
        
    } catch (error) {
        console.error('‚ùå Error notifying marketing:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Save chat message to database
 * @private
 * @param {Object} chatData - Chat message data
 * @param {Object} intentAnalysis - GPT intent analysis
 */
async function saveChatMessage(chatData, intentAnalysis) {
    try {
        const messageId = 'chat_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
        const timestamp = new Date();
        
        const chatRecord = {
            _id: messageId,
            message: chatData.message,
            userId: chatData.userId || 'guest',
            userEmail: chatData.userEmail || null,
            userName: chatData.userName || null,
            sessionId: chatData.sessionId || null,
            pageUrl: chatData.pageUrl || null,
            source: 'mission_support_form',
            intent: intentAnalysis.intent,
            needsHumanResponse: intentAnalysis.needsHumanResponse,
            priority: intentAnalysis.priority || 'normal',
            category: intentAnalysis.category || 'general',
            notified: true,
            notifiedAt: timestamp,
            created_at: timestamp,
            metadata: {
                intentAnalysis: intentAnalysis,
                userAgent: chatData.userAgent || null,
                referrer: chatData.referrer || null
            }
        };
        
        // Save to ChatMessages collection
        await wixData.save('ChatMessages', chatRecord);
        console.log('‚úÖ Chat message saved to database:', messageId);
        
        return {
            success: true,
            messageId: messageId
        };
        
    } catch (error) {
        console.error('‚ùå Error saving chat message:', error);
        throw error;
    }
}

/**
 * Analyze chat message intent using GPT
 * Determines if message needs human response
 * @private
 * @param {string} message - Chat message text
 */
async function analyzeChatIntent(message) {
    try {
        // Get OpenAI API key
        let openaiKey;
        try {
            openaiKey = await secrets.getSecret('OPENAI_API_KEY');
        } catch (e) {
            console.warn('‚ö†Ô∏è OpenAI API key not found, using default analysis');
            // Default analysis - assume it's a question if it contains question words
            const questionWords = ['why', 'what', 'how', 'when', 'where', 'who', '?', 'help', 'support', 'question'];
            const isQuestion = questionWords.some(word => message.toLowerCase().includes(word));
            return {
                intent: isQuestion ? 'question' : 'statement',
                needsHumanResponse: isQuestion,
                priority: isQuestion ? 'normal' : 'low',
                category: 'general',
                confidence: 0.7
            };
        }
        
        const prompt = `Analyze this chat message from a user on the HingeCraft Mission Support form and determine if it needs a human response.

Message: "${message}"

Respond in JSON format with:
{
  "intent": "question|statement|complaint|compliment|other",
  "needsHumanResponse": true|false,
  "priority": "high|normal|low",
  "category": "payment|technical|general|support|other",
  "summary": "Brief summary of the message",
  "confidence": 0.0-1.0,
  "suggestedResponse": "Suggested automated response if not needing human"
}

Rules:
- Questions about payment, technical issues, or support typically need human response
- Simple greetings or thank you messages don't need human response
- Complaints or urgent issues need high priority human response
- General questions about the mission or organization may need human response`;

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${openaiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4-turbo-preview',
                messages: [
                    {
                        role: 'system',
                        content: 'You are an expert at analyzing customer chat messages and determining if they need human intervention. Be precise and accurate.'
                    },
                    {
                        role: 'user',
                        content: prompt
                    }
                ],
                temperature: 0.3,
                max_tokens: 500
            })
        });
        
        if (!response.ok) {
            throw new Error(`OpenAI API error: ${response.status}`);
        }
        
        const data = await response.json();
        const content = data.choices[0].message.content;
        
        // Parse JSON from response
        const analysis = JSON.parse(content);
        
        return {
            intent: analysis.intent || 'other',
            needsHumanResponse: analysis.needsHumanResponse || false,
            priority: analysis.priority || 'normal',
            category: analysis.category || 'general',
            summary: analysis.summary || message.substring(0, 100),
            confidence: analysis.confidence || 0.8,
            suggestedResponse: analysis.suggestedResponse || null
        };
        
    } catch (error) {
        console.error('‚ùå GPT intent analysis error:', error);
        // Fallback analysis
        const questionWords = ['why', 'what', 'how', 'when', 'where', 'who', '?', 'help', 'support', 'question'];
        const isQuestion = questionWords.some(word => message.toLowerCase().includes(word));
        return {
            intent: isQuestion ? 'question' : 'statement',
            needsHumanResponse: isQuestion,
            priority: isQuestion ? 'normal' : 'low',
            category: 'general',
            summary: message.substring(0, 100),
            confidence: 0.6
        };
    }
}

/**
 * Generate marketing notification email
 * @private
 * @param {Object} chatData - Chat message data
 * @param {Object} intentAnalysis - Intent analysis
 */
async function generateMarketingNotificationEmail(chatData, intentAnalysis) {
    const userName = chatData.userName || chatData.userEmail || 'Guest User';
    const userEmail = chatData.userEmail || 'No email provided';
    const pageUrl = chatData.pageUrl || 'Unknown page';
    const timestamp = new Date().toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
    
    const priorityBadge = intentAnalysis.priority === 'high' 
        ? '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">HIGH PRIORITY</span>'
        : intentAnalysis.priority === 'normal'
        ? '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">NORMAL</span>'
        : '<span style="background: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">LOW</span>';
    
    const subject = `[${intentAnalysis.priority.toUpperCase()}] Live Chat Question from ${userName} - ${intentAnalysis.category}`;
    
    const html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f5f5f5;">
    <div style="background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #10b981;">
            <h1 style="color: #10b981; margin: 0; font-size: 24px;">üîî New Live Chat Question</h1>
            <p style="color: #666; margin: 10px 0 0 0;">HingeCraft Mission Support Form</p>
        </div>
        
        <!-- Priority Badge -->
        <div style="text-align: center; margin-bottom: 20px;">
            ${priorityBadge}
        </div>
        
        <!-- User Information -->
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h2 style="color: #333; margin-top: 0; font-size: 18px;">User Information</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666; width: 120px;">Name:</td>
                    <td style="padding: 8px 0; color: #333;">${userName}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666;">Email:</td>
                    <td style="padding: 8px 0; color: #333;">${userEmail}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666;">Page:</td>
                    <td style="padding: 8px 0; color: #333;">${pageUrl}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666;">Time:</td>
                    <td style="padding: 8px 0; color: #333;">${timestamp}</td>
                </tr>
            </table>
        </div>
        
        <!-- Message -->
        <div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 20px; margin-bottom: 20px; border-radius: 4px;">
            <h2 style="color: #333; margin-top: 0; font-size: 18px;">üí¨ User Message</h2>
            <p style="margin: 0; font-size: 16px; color: #333; white-space: pre-wrap;">${chatData.message}</p>
        </div>
        
        <!-- Intent Analysis -->
        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 20px; margin-bottom: 20px; border-radius: 4px;">
            <h2 style="color: #333; margin-top: 0; font-size: 18px;">ü§ñ AI Analysis</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666; width: 150px;">Intent:</td>
                    <td style="padding: 8px 0; color: #333; text-transform: capitalize;">${intentAnalysis.intent}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666;">Category:</td>
                    <td style="padding: 8px 0; color: #333; text-transform: capitalize;">${intentAnalysis.category}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666;">Summary:</td>
                    <td style="padding: 8px 0; color: #333;">${intentAnalysis.summary || 'N/A'}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; font-weight: bold; color: #666;">Confidence:</td>
                    <td style="padding: 8px 0; color: #333;">${(intentAnalysis.confidence * 100).toFixed(0)}%</td>
                </tr>
            </table>
            ${intentAnalysis.suggestedResponse ? `
            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                <strong style="color: #666;">Suggested Automated Response:</strong>
                <p style="margin: 8px 0 0 0; color: #333; font-style: italic;">${intentAnalysis.suggestedResponse}</p>
            </div>
            ` : ''}
        </div>
        
        <!-- Action Buttons -->
        <div style="text-align: center; margin: 30px 0; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <p style="margin: 0 0 15px 0; color: #666;">Quick Actions:</p>
            <a href="mailto:${userEmail}?subject=Re: Your question about HingeCraft" 
               style="display: inline-block; padding: 12px 24px; background: #10b981; color: white; text-decoration: none; border-radius: 6px; margin: 5px; font-weight: bold;">
               Reply to User
            </a>
            <a href="${pageUrl}" 
               style="display: inline-block; padding: 12px 24px; background: #6b7280; color: white; text-decoration: none; border-radius: 6px; margin: 5px; font-weight: bold;">
               View Page
            </a>
        </div>
        
        <!-- Footer -->
        <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; color: #666; font-size: 12px;">
            <p style="margin: 5px 0;">¬© ${new Date().getFullYear()} HingeCraft Global. All rights reserved.</p>
            <p style="margin: 5px 0; font-size: 11px;">This is an automated notification from the HingeCraft Live Chat system.</p>
        </div>
    </div>
</body>
</html>
    `;
    
    const text = `
üîî New Live Chat Question
HingeCraft Mission Support Form

Priority: ${intentAnalysis.priority.toUpperCase()}

USER INFORMATION
================
Name: ${userName}
Email: ${userEmail}
Page: ${pageUrl}
Time: ${timestamp}

USER MESSAGE
============
${chatData.message}

AI ANALYSIS
===========
Intent: ${intentAnalysis.intent}
Category: ${intentAnalysis.category}
Summary: ${intentAnalysis.summary || 'N/A'}
Confidence: ${(intentAnalysis.confidence * 100).toFixed(0)}%
${intentAnalysis.suggestedResponse ? `\nSuggested Response: ${intentAnalysis.suggestedResponse}` : ''}

QUICK ACTIONS
=============
Reply to User: mailto:${userEmail}?subject=Re: Your question about HingeCraft
View Page: ${pageUrl}

¬© ${new Date().getFullYear()} HingeCraft Global. All rights reserved.
This is an automated notification from the HingeCraft Live Chat system.
    `;
    
    return {
        subject: subject,
        html: html,
        text: text
    };
}

/**
 * Send notification email to marketing
 * @private
 * @param {string} marketingEmail - Marketing email address
 * @param {Object} emailContent - Email content
 */
async function sendNotificationEmail(marketingEmail, emailContent) {
    try {
        // Try SendGrid first
        let sendgridKey;
        try {
            sendgridKey = await secrets.getSecret('SENDGRID_API_KEY');
        } catch (e) {
            console.warn('SendGrid not configured');
        }
        
        if (sendgridKey) {
            const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${sendgridKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    personalizations: [{
                        to: [{ email: marketingEmail }]
                    }],
                    from: { email: 'no-reply@hingecraft-global.ai' },
                    subject: emailContent.subject,
                    content: [
                        { type: 'text/plain', value: emailContent.text },
                        { type: 'text/html', value: emailContent.html }
                    ]
                })
            });
            
            if (response.ok) {
                console.log('‚úÖ Marketing notification sent via SendGrid');
                return { success: true, service: 'sendgrid' };
            } else {
                const error = await response.text();
                console.error('SendGrid error:', error);
                throw new Error('SendGrid failed');
            }
        }
        
        // Fallback: Log for manual sending
        console.warn('‚ö†Ô∏è Email service not configured. Notification would be sent to:', marketingEmail);
        console.log('Email Subject:', emailContent.subject);
        console.log('Email Content:', emailContent.text);
        
        return { 
            success: false, 
            error: 'Email service not configured',
            service: 'none',
            emailContent: emailContent
        };
        
    } catch (error) {
        console.error('‚ùå Email send error:', error);
        return { 
            success: false, 
            error: error.message,
            service: 'sendgrid'
        };
    }
}

/**
 * Save chat message to database
 * @public
 * @param {Object} chatData - Chat message data
 */
export async function saveChatMessage(chatData) {
    try {
        const messageId = 'chat_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 9);
        const timestamp = new Date();
        
        // Analyze intent
        const intentAnalysis = await analyzeChatIntent(chatData.message);
        
        const chatRecord = {
            _id: messageId,
            message: chatData.message,
            userId: chatData.userId || 'guest',
            userEmail: chatData.userEmail || null,
            userName: chatData.userName || null,
            sessionId: chatData.sessionId || null,
            pageUrl: chatData.pageUrl || null,
            source: chatData.source || 'mission_support_form',
            intent: intentAnalysis.intent,
            needsHumanResponse: intentAnalysis.needsHumanResponse,
            priority: intentAnalysis.priority || 'normal',
            category: intentAnalysis.category || 'general',
            notified: false,
            created_at: timestamp,
            metadata: {
                intentAnalysis: intentAnalysis,
                userAgent: chatData.userAgent || null,
                referrer: chatData.referrer || null
            }
        };
        
        // Save to ChatMessages collection
        await wixData.save('ChatMessages', chatRecord);
        console.log('‚úÖ Chat message saved:', messageId);
        
        // If needs human response, notify marketing
        if (intentAnalysis.needsHumanResponse) {
            try {
                await notifyMarketingOnQuestion(chatData);
            } catch (notifyError) {
                console.warn('‚ö†Ô∏è Error notifying marketing (non-blocking):', notifyError);
            }
        }
        
        return {
            success: true,
            messageId: messageId,
            intentAnalysis: intentAnalysis
        };
        
    } catch (error) {
        console.error('‚ùå Error saving chat message:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

/**
 * Get chat history for a user
 * @public
 * @param {string} userId - User ID or session ID
 */
export async function getChatHistory(userId) {
    try {
        const messages = await wixData.query('ChatMessages')
            .eq('userId', userId)
            .or(wixData.query('ChatMessages').eq('sessionId', userId))
            .ascending('created_at')
            .find();
        
        return {
            success: true,
            messages: messages.items,
            count: messages.items.length
        };
    } catch (error) {
        console.error('‚ùå Error getting chat history:', error);
        return {
            success: false,
            error: error.message
        };
    }
}
