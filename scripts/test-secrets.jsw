/**
 * Test Secrets Configuration
 * 
 * This file helps verify that all required secrets are configured correctly.
 * 
 * Usage:
 * 1. Save this file as: src/backend/test-secrets.jsw
 * 2. Call from frontend or backend to verify secrets
 * 3. Remove or comment out after verification
 */

import { secrets } from 'wix-secrets-backend';

/**
 * Test all required secrets
 * @returns {Promise<Object>} Status of each secret
 */
export async function testAllSecrets() {
    const results = {
        timestamp: new Date().toISOString(),
        secrets: {}
    };

    // Test STRIPE_SECRET_KEY_LIVE (or STRIPE_SECRET_KEY as fallback)
    try {
        let stripeKey = await secrets.getSecret('STRIPE_SECRET_KEY_LIVE');
        if (!stripeKey) {
            stripeKey = await secrets.getSecret('STRIPE_SECRET_KEY');
        }
        results.secrets.STRIPE_SECRET_KEY_LIVE = {
            status: stripeKey ? '✅ Configured' : '❌ Missing',
            hasValue: !!stripeKey,
            length: stripeKey ? stripeKey.length : 0,
            startsWith: stripeKey ? stripeKey.substring(0, 7) : 'N/A',
            note: stripeKey ? 'Using STRIPE_SECRET_KEY_LIVE or STRIPE_SECRET_KEY' : 'Neither found'
        };
    } catch (error) {
        results.secrets.STRIPE_SECRET_KEY_LIVE = {
            status: '❌ Error',
            error: error.message
        };
    }

    // Test STRIPE_WEBHOOK_SECRET_LIVE
    try {
        const stripeWebhook = await secrets.getSecret('STRIPE_WEBHOOK_SECRET_LIVE');
        results.secrets.STRIPE_WEBHOOK_SECRET_LIVE = {
            status: stripeWebhook ? '✅ Configured' : '❌ Missing',
            hasValue: !!stripeWebhook,
            length: stripeWebhook ? stripeWebhook.length : 0,
            startsWith: stripeWebhook ? stripeWebhook.substring(0, 6) : 'N/A'
        };
    } catch (error) {
        results.secrets.STRIPE_WEBHOOK_SECRET_LIVE = {
            status: '❌ Error',
            error: error.message
        };
    }

    // Test NOWPAYMENTS_API_KEY
    try {
        const nowPaymentsKey = await secrets.getSecret('NOWPAYMENTS_API_KEY');
        results.secrets.NOWPAYMENTS_API_KEY = {
            status: nowPaymentsKey ? '✅ Configured' : '❌ Missing',
            hasValue: !!nowPaymentsKey,
            length: nowPaymentsKey ? nowPaymentsKey.length : 0
        };
    } catch (error) {
        results.secrets.NOWPAYMENTS_API_KEY = {
            status: '❌ Error',
            error: error.message
        };
    }

    // Test NOWPAYMENTS_IPN_SECRET
    try {
        const nowPaymentsIPN = await secrets.getSecret('NOWPAYMENTS_IPN_SECRET');
        results.secrets.NOWPAYMENTS_IPN_SECRET = {
            status: nowPaymentsIPN ? '✅ Configured' : '❌ Missing',
            hasValue: !!nowPaymentsIPN,
            length: nowPaymentsIPN ? nowPaymentsIPN.length : 0
        };
    } catch (error) {
        results.secrets.NOWPAYMENTS_IPN_SECRET = {
            status: '❌ Error',
            error: error.message
        };
    }

    // Summary
    const allConfigured = Object.values(results.secrets).every(
        secret => secret.status === '✅ Configured'
    );

    results.summary = {
        allConfigured: allConfigured,
        totalSecrets: 4,
        configuredCount: Object.values(results.secrets).filter(
            secret => secret.status === '✅ Configured'
        ).length
    };

    return results;
}

/**
 * Quick check - returns true if all secrets are configured
 * @returns {Promise<boolean>}
 */
export async function areSecretsConfigured() {
    try {
        const results = await testAllSecrets();
        return results.summary.allConfigured;
    } catch (error) {
        console.error('Error checking secrets:', error);
        return false;
    }
}
