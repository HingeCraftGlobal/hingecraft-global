<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HingeCraft Global - Live Chat</title>
    <!-- T10 Chat System Styles -->
    <link rel="stylesheet" href="/css/hc-uix.css">
    <!-- T10 Chat System Scripts -->
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="/js/hc-client.js"></script>
    <style>
        /* Existing styles for gallery, country list, etc. */
        .thumb { cursor: pointer; }
        .thumb.active { border: 2px solid #6a4ad8; }
        .country-list { list-style: none; padding: 0; }
        .country-list li { padding: 8px; border-bottom: 1px solid #e0d8ff; }
        .country-name { font-weight: 600; }
        .country-meta { display: flex; gap: 12px; }
        .country-count { color: #666; }
        .country-code { color: #6a4ad8; font-weight: 600; }
        .invite-btn, button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .un-time { padding: 12px; background: #f8f9fa; border-radius: 8px; margin-top: 20px; }
        .un-time-label { font-weight: 600; margin-bottom: 4px; }
        .un-time-value { font-family: monospace; }
    </style>
</head>
<body>
    <!-- Your existing HTML structure -->
    <!-- Country List -->
    <ul class="country-list">
        <li>
            <span class="country-name">Togo</span>
            <span class="country-meta">
                <span class="country-count">5,062</span>
                <span class="country-code">TG</span>
            </span>
        </li>
        <li>
            <span class="country-name">Tunisia</span>
            <span class="country-meta">
                <span class="country-count">2,299</span>
                <span class="country-code">TN</span>
            </span>
        </li>
        <li>
            <span class="country-name">Turkey</span>
            <span class="country-meta">
                <span class="country-count">16,216</span>
                <span class="country-code">TR</span>
            </span>
        </li>
        <li>
            <span class="country-name">Uganda</span>
            <span class="country-meta">
                <span class="country-count">3,156</span>
                <span class="country-code">UG</span>
            </span>
        </li>
        <li>
            <span class="country-name">Ukraine</span>
            <span class="country-meta">
                <span class="country-count">7,404</span>
                <span class="country-code">UA</span>
            </span>
        </li>
        <li>
            <span class="country-name">United Arab Emirates</span>
            <span class="country-meta">
                <span class="country-count">6,794</span>
                <span class="country-code">AE</span>
            </span>
        </li>
        <li>
            <span class="country-name">United Kingdom</span>
            <span class="country-meta">
                <span class="country-count">6,856</span>
                <span class="country-code">GB</span>
            </span>
        </li>
        <li>
            <span class="country-name">United States</span>
            <span class="country-meta">
                <span class="country-count">5,916</span>
                <span class="country-code">US</span>
            </span>
        </li>
        <li>
            <span class="country-name">Uruguay</span>
            <span class="country-meta">
                <span class="country-count">2,376</span>
                <span class="country-code">UY</span>
            </span>
        </li>
        <li>
            <span class="country-name">Venezuela</span>
            <span class="country-meta">
                <span class="country-count">7,232</span>
                <span class="country-code">VE</span>
            </span>
        </li>
        <li>
            <span class="country-name">Vietnam</span>
            <span class="country-meta">
                <span class="country-count">5,525</span>
                <span class="country-code">VN</span>
            </span>
        </li>
        <li>
            <span class="country-name">Zambia</span>
            <span class="country-meta">
                <span class="country-count">7,094</span>
                <span class="country-code">ZM</span>
            </span>
        </li>
        <li>
            <span class="country-name">Zimbabwe</span>
            <span class="country-meta">
                <span class="country-count">3,084</span>
                <span class="country-code">ZW</span>
            </span>
        </li>
    </ul>

    <!-- Portal Buttons -->
    <button class="invite-btn" onclick="window.location.href='https://www.hingecraft-global.ai/invitation';">Invite a Friend</button>
    <button onclick="window.location.href='https://www.hingecraft-global.ai/membership-page';">Member Portal</button>
    <button onclick="window.location.href='https://www.hingecraft-global.ai/ambassador-portal';">Ambassador Portal</button>
    <button onclick="window.location.href='https://www.hingecraft-global.ai/support';">Supporter Portal</button>

    <!-- T10 Live Chat System - Integrated into existing chatBox -->
    <div id="chatBox" class="hc-messages" role="log" aria-live="polite" aria-label="Chat messages" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0d8ff; border-radius: 8px; padding: 12px; margin: 20px 0;">
        <div class="hc-loading" id="loadingIndicator">Loading messages...</div>
    </div>

    <!-- Chat Input (replaces existing .chat-input) -->
    <div class="hc-composer" role="form" aria-label="Message composer" style="margin-top: 12px;">
        <div class="hc-composer-input-wrapper">
            <textarea 
                class="hc-composer-input chat-input" 
                id="messageInput"
                placeholder="Type a message..."
                rows="1"
                aria-label="Message input"
                maxlength="5000"
                style="width: 100%; padding: 10px; border: 1px solid #e0d8ff; border-radius: 8px; font-family: inherit; resize: vertical;"
            ></textarea>
            <div class="hc-composer-actions" style="margin-top: 8px;">
                <button 
                    class="hc-btn hc-btn-secondary" 
                    id="attachBtn"
                    type="button"
                    aria-label="Attach file"
                    title="Attach file (max 12MB)"
                    style="padding: 8px 16px; margin-right: 8px;"
                >ðŸ“Ž</button>
                <input 
                    type="file" 
                    id="fileInput" 
                    multiple 
                    style="display: none;"
                    accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
                    aria-label="File input"
                >
                <button 
                    class="hc-btn hc-btn-primary" 
                    id="sendBtn"
                    type="button"
                    aria-label="Send message"
                    style="padding: 8px 20px;"
                >Send</button>
            </div>
        </div>
        <div id="validationError" class="hc-validation-error" role="alert" aria-live="polite" style="margin-top: 8px;"></div>
    </div>

    <!-- Typing Indicator -->
    <div class="hc-typing-indicator" id="typingIndicator" aria-live="polite" style="display: none; padding: 8px; color: #666; font-style: italic;"></div>

    <!-- Error Message -->
    <div id="errorMessage" class="hc-error" role="alert" aria-live="polite" style="display: none; margin-top: 12px;"></div>

    <!-- Thread Modal -->
    <div id="threadModal" class="hc-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="threadModalTitle" style="display: none;">
        <div class="hc-modal">
            <div class="hc-modal-header">
                <h2 id="threadModalTitle" class="hc-modal-title">Thread</h2>
                <button class="hc-modal-close" id="threadModalClose" aria-label="Close thread">Ã—</button>
            </div>
            <div id="threadContent" class="hc-messages"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Gallery logic: clicking a thumbnail updates main photo and description box ---
            const thumbs = document.querySelectorAll('.thumb');
            const mainPhotoImg = document.getElementById('mainPhotoImg');
            const mainPhotoLabel = document.getElementById('mainPhotoLabel');
            const captionText = document.getElementById('photoCaptionText');
            const captionCredit = document.getElementById('photoCaptionCredit');

            function activateThumb(thumb) {
                thumbs.forEach(function (t) { t.classList.remove('active'); });
                thumb.classList.add('active');

                const src = thumb.getAttribute('data-src');
                const label = thumb.getAttribute('data-label');
                const caption = thumb.getAttribute('data-caption');
                const credit = thumb.getAttribute('data-credit');
                const ts = thumb.getAttribute('data-timestamp');

                if (src && mainPhotoImg) {
                    mainPhotoImg.src = src;
                }
                if (label && mainPhotoLabel) {
                    mainPhotoLabel.textContent = label;
                }
                if (caption && captionText) {
                    captionText.textContent = caption;
                }
                if (credit && captionCredit) {
                    captionCredit.textContent = credit;
                }
                const tsEl = document.getElementById('photoTimestamp');
                if (tsEl && ts) {
                    tsEl.textContent = ts;
                }
            }

            thumbs.forEach(function (thumb) {
                thumb.addEventListener('click', function () {
                    activateThumb(thumb);
                });
            });

            if (thumbs.length > 0) {
                activateThumb(thumbs[0]);
            }

            // --- UN New York time display ---
            const unTimeEl = document.getElementById('unTimeValue');
            function updateUNTime() {
                if (!unTimeEl) return;
                const now = new Date();
                try {
                    const options = {
                        timeZone: 'America/New_York',
                        year: 'numeric',
                        month: 'short',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    };
                    const formatter = new Intl.DateTimeFormat('en-US', options);
                    unTimeEl.textContent = formatter.format(now);
                } catch (e) {
                    unTimeEl.textContent = now.toLocaleString();
                }
            }
            updateUNTime();
            setInterval(updateUNTime, 1000);

            // ============================================
            // T10 LIVE CHAT SYSTEM INTEGRATION
            // ============================================
            
            // Initialize Chat Client
            const client = new HingeCraftChatClient({
                baseUrl: window.location.origin,
                channels: ['#general', '#support', '#random'],
                defaultChannel: '#general'
            });

            // State
            let currentChannel = '#general';
            let messages = [];
            let typingUsers = new Set();
            let pendingAttachments = [];

            // DOM Elements
            const chatBox = document.getElementById('chatBox');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');
            const typingIndicator = document.getElementById('typingIndicator');
            const errorMessage = document.getElementById('errorMessage');
            const validationError = document.getElementById('validationError');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const threadModal = document.getElementById('threadModal');
            const threadContent = document.getElementById('threadContent');

            // Get display name from existing user-id element
            function getDisplayName() {
                const userIdEl = document.querySelector('.user-id');
                if (!userIdEl) return 'Member';
                const txt = userIdEl.textContent || '';
                const firstSegment = txt.split('â€¢')[0];
                if (!firstSegment) return 'Member';
                return firstSegment.replace('User:', '').trim() || 'Member';
            }

            // Initialize T10 Chat System
            async function initChat() {
                try {
                    // Initialize client
                    await client.init();
                    console.log('T10 Chat client initialized');

                    // Set up event handlers
                    setupChatHandlers();

                    // Load messages
                    await loadMessages();

                    // Join channel
                    if (client.socket && typeof io !== 'undefined') {
                        client.socket.emit('join', currentChannel);
                    }

                    // Set up client callbacks
                    client.onMessageReceived = handleMessageReceived;
                    client.onMessageEdit = handleMessageEdit;
                    client.onMessageDelete = handleMessageDelete;
                    client.onReactionUpdate = handleReactionUpdate;
                    client.onTypingUpdate = handleTypingUpdate;
                    client.onPresenceUpdate = handlePresenceUpdate;
                    client.onPinUpdate = handlePinUpdate;
                    client.onThreadUpdate = handleThreadUpdate;
                    client.onMessageOptimistic = handleMessageOptimistic;
                    client.onMessageError = handleMessageError;

                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Failed to initialize chat:', error);
                    if (loadingIndicator) {
                        loadingIndicator.textContent = 'Failed to load. Please refresh.';
                    }
                    showError('Failed to initialize chat: ' + error.message);
                }
            }

            // Setup event handlers
            function setupChatHandlers() {
                // Send message
                if (sendBtn) {
                    sendBtn.addEventListener('click', handleSend);
                }
                if (messageInput) {
                    messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleSend();
                        }
                    });

                    // Typing indicator
                    let typingTimeout;
                    messageInput.addEventListener('input', () => {
                        clearTimeout(typingTimeout);
                        client.sendTyping(currentChannel);
                        typingTimeout = setTimeout(() => {
                            // Typing stopped
                        }, 3000);
                    });
                }

                // File attachment
                if (attachBtn) {
                    attachBtn.addEventListener('click', () => fileInput.click());
                }
                if (fileInput) {
                    fileInput.addEventListener('change', handleFileSelect);
                }

                // Modal close handlers
                const threadModalClose = document.getElementById('threadModalClose');
                if (threadModalClose) {
                    threadModalClose.addEventListener('click', () => {
                        threadModal.style.display = 'none';
                    });
                }

                if (threadModal) {
                    threadModal.addEventListener('click', (e) => {
                        if (e.target === threadModal) {
                            threadModal.style.display = 'none';
                        }
                    });
                }
            }

            // Load messages
            async function loadMessages() {
                try {
                    const data = await client.getMessages(currentChannel, { limit: 50 });
                    messages = data.messages || [];
                    renderMessages();
                } catch (error) {
                    console.error('Failed to load messages:', error);
                    showError('Failed to load messages: ' + error.message);
                }
            }

            // Render messages (inserts at top like original)
            function renderMessages() {
                if (!chatBox) return;
                
                // Clear loading indicator
                const loading = chatBox.querySelector('.hc-loading');
                if (loading) loading.remove();

                // Sort: pinned first, then by timestamp (newest first for top insertion)
                const sorted = [...messages].sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return new Date(b.ts) - new Date(a.ts); // Reverse for top insertion
                });

                // Clear existing messages
                chatBox.innerHTML = '';

                // Insert messages at top
                sorted.forEach(msg => {
                    const element = createMessageElement(msg);
                    chatBox.insertBefore(element, chatBox.firstChild);
                });

                // Scroll to top (like original)
                chatBox.scrollTop = 0;
            }

            // Create message element (simplified for existing chatBox style)
            function createMessageElement(message) {
                const p = document.createElement('p');
                const name = message.user_name || getDisplayName() || 'Member';
                const text = message.text || '';
                
                // Format similar to original: <b>Name:</b> message
                p.innerHTML = '<b>' + name + ':</b> ' + text;
                
                // Add data attributes for T10 system
                p.setAttribute('data-message-id', message.id);
                p.className = 'hc-message' + (message.pending ? ' pending' : '');
                
                return p;
            }

            // Handle send
            async function handleSend() {
                if (!messageInput) return;
                const text = messageInput.value.trim();
                if (!text && pendingAttachments.length === 0) return;

                // Validate
                if (text.length > 5000) {
                    showValidationError('Message cannot exceed 5000 characters');
                    return;
                }

                try {
                    // Upload attachments first
                    const attachments = [];
                    for (const file of pendingAttachments) {
                        try {
                            const uploadResult = await client.uploadFile(file, currentChannel, 'ct_temp');
                            attachments.push({
                                name: file.name,
                                mime: file.type,
                                url: uploadResult.fileUrl,
                                size: file.size
                            });
                        } catch (error) {
                            showError('Failed to upload ' + file.name + ': ' + error.message);
                        }
                    }

                    // Send message
                    await client.sendMessage(currentChannel, text, {
                        attachments,
                        clientTempId: client.generateClientTempId()
                    });

                    // Clear input
                    messageInput.value = '';
                    pendingAttachments = [];
                    validationError.textContent = '';
                } catch (error) {
                    showError('Failed to send message: ' + error.message);
                }
            }

            // Handle file select
            function handleFileSelect(e) {
                const files = Array.from(e.target.files);
                const maxSize = 12 * 1024 * 1024; // 12MB

                files.forEach(file => {
                    if (file.size > maxSize) {
                        showValidationError(`${file.name} exceeds 12MB limit`);
                        return;
                    }
                    pendingAttachments.push(file);
                });

                fileInput.value = '';
            }

            // Event handlers
            function handleMessageReceived(message) {
                if (message.channel === currentChannel) {
                    const existingIndex = messages.findIndex(m => m.id === message.id);
                    if (existingIndex >= 0) {
                        messages[existingIndex] = message;
                    } else {
                        messages.push(message);
                    }
                    renderMessages();
                }
            }

            function handleMessageOptimistic(message) {
                messages.push(message);
                renderMessages();
            }

            function handleMessageError(clientTempId, error) {
                messages = messages.filter(m => m.clientTempId !== clientTempId);
                renderMessages();
                showError('Failed to send message: ' + error.message);
            }

            function handleMessageEdit(message) {
                const index = messages.findIndex(m => m.id === message.id);
                if (index >= 0) {
                    messages[index] = message;
                    renderMessages();
                }
            }

            function handleMessageDelete(messageId) {
                messages = messages.filter(m => m.id !== messageId);
                renderMessages();
            }

            function handleReactionUpdate(messageId, reactions) {
                const message = messages.find(m => m.id === messageId);
                if (message) {
                    message.reactions = reactions;
                    renderMessages();
                }
            }

            function handleTypingUpdate(channel, userId, ts) {
                if (channel === currentChannel && userId !== client.user.id) {
                    typingUsers.add(userId);
                    updateTypingIndicator();
                    setTimeout(() => {
                        typingUsers.delete(userId);
                        updateTypingIndicator();
                    }, 3000);
                }
            }

            function handlePresenceUpdate(userId, status, lastSeen) {
                console.log('Presence update:', userId, status);
            }

            function handlePinUpdate(messageId, pinned) {
                const message = messages.find(m => m.id === messageId);
                if (message) {
                    message.pinned = pinned;
                    renderMessages();
                }
            }

            function handleThreadUpdate(rootMessageId, replies) {
                console.log('Thread update:', rootMessageId, replies);
            }

            // Utility functions
            function updateTypingIndicator() {
                if (typingIndicator) {
                    if (typingUsers.size > 0) {
                        typingIndicator.textContent = `${typingUsers.size} user${typingUsers.size > 1 ? 's' : ''} typing...`;
                        typingIndicator.style.display = 'block';
                    } else {
                        typingIndicator.style.display = 'none';
                    }
                }
            }

            function showError(message) {
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.style.display = 'block';
                    setTimeout(() => {
                        errorMessage.style.display = 'none';
                    }, 5000);
                }
            }

            function showValidationError(message) {
                if (validationError) {
                    validationError.textContent = message;
                    setTimeout(() => {
                        validationError.textContent = '';
                    }, 5000);
                }
            }

            // Initialize T10 Chat System
            initChat();
        });
    </script>

    <!-- UN Time Display -->
    <div class="un-time" id="unTimeBox">
        <div class="un-time-label">UN New York Time</div>
        <div class="un-time-value" id="unTimeValue">Loadingâ€¦</div>
    </div>
</body>
</html>

