<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HingeCraft Charter - Membership</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://static.parastorage.com/services/js-sdk/1.231.0/js/wix-private.js"></script>
  <style>
    .prose h1 { font-size: 1.5rem; font-weight: 700; margin-top: 1.25rem; }
    .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1rem; }
    .prose p { margin-top: 0.75rem; line-height: 1.6; }
    .prose ul, .prose ol { margin-left: 1.25rem; margin-top: 0.5rem; }
    .prose li { margin-top: 0.25rem; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="root" class="min-h-screen py-6"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useState } = React;
    const HCMP_VERSION = "v1.3.0 (Wix Ready)";
    
    // Velo API Configuration - All paths use /_functions/[module-name]
    // IMPORTANT: Module names must match exactly with backend file names (without .web.js extension)
    const VELO_CONFIG = {
      CHARTER_MIDDLEWARE: '/_functions/charter-page-middleware',
      NOWPAYMENTS_API: '/_functions/nowpayments.api',
      STRIPE_API: '/_functions/stripe.api',
      HINGECRAFT_API: '/_functions/hingecraft.api',
      MISSION_SUPPORT_MIDDLEWARE: '/_functions/mission-support-middleware'
    };
    
    // Helper function to call Wix Velo functions with proper error handling
    async function callVeloFunction(modulePath, functionName, data = {}) {
      try {
        // Use wixFetch if available (Wix environment), otherwise use fetch
        const fetchFn = typeof wixFetch !== 'undefined' ? wixFetch.fetch : fetch;
        
        // Wix Velo functions are called via: /_functions/[module-name]/[function-name]
        const url = `${modulePath}/${functionName}`;
        
        console.log(`üìû Calling Velo function: ${url}`, data);
        
        const response = await fetchFn(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        // Check for CloudFront errors (403, 404, etc.)
        if (!response.ok) {
          const errorText = await response.text();
          
          // Check if it's a CloudFront error
          if (errorText.includes('CloudFront') || errorText.includes('403 ERROR') || response.status === 403) {
            console.error(`‚ùå CloudFront 403 Error - Function not found or incorrect path: ${url}`);
            throw new Error(`Function not accessible. Check that '${functionName}' is exported in the backend module.`);
          }
          
          console.error(`‚ùå HTTP Error ${response.status}:`, errorText);
          throw new Error(`Server error: ${response.status} - ${errorText.substring(0, 200)}`);
        }
        
        const result = await response.json();
        console.log(`‚úÖ Velo function response:`, result);
        return result;
        
      } catch (error) {
        console.error(`‚ùå Error calling Velo function ${modulePath}/${functionName}:`, error);
        throw error;
      }
    }

    // Payment Routes Map - Will be populated from database
    // This is the SINGLE SOURCE OF TRUTH for currency -> payment URL mapping
    const PAYMENT_ROUTES = {
      'SOL_USDC': {
        type: 'crypto',
        provider: 'nowpayments',
        coin: 'solana',
        currency: 'SOL',
        // URL will be set when invoice is created
        url: null,
        walletAddress: null
      },
      'XLM_USDC': {
        type: 'crypto',
        provider: 'nowpayments',
        coin: 'stellar',
        currency: 'XLM',
        url: null,
        walletAddress: null
      },
      'BTC_LN': {
        type: 'crypto',
        provider: 'nowpayments',
        coin: 'bitcoin',
        currency: 'BTC',
        url: null,
        walletAddress: null
      },
      'CARD': {
        type: 'fiat',
        provider: 'stripe',
        method: 'card',
        currency: 'USD',
        // URL will be set when session is created
        url: null
      },
      'ACH': {
        type: 'fiat',
        provider: 'stripe',
        method: 'ach',
        currency: 'USD',
        url: null
      }
    };

    const TIERS = [
      { key: "BASIC", name: "Basic (Entry)", priceHint: "$1 ‚Üí 1 year", description: "Join the movement. Full portal access, lifetime registry, read-only publications, community social access.", bullets: ["Portal login & social participation","Lifetime registry inclusion","Read-only reports & publications","Name on public charters (opt-in)"], accent: "from-emerald-500 to-teal-500" },
      { key: "PREMIER", name: "Premier (Extended)", priceHint: "$2‚Äì$20 ‚Üí 2‚Äì20 years", description: "Deeper engagement. Downloads + clubs/think tanks. Each extra dollar adds a year (up to 20).", bullets: ["Download books, audiobooks, reports","Start or join thematic clubs","Leadership in communities"], accent: "from-indigo-500 to-sky-500" },
      { key: "VIP", name: "VIP (Lifetime)", priceHint: "$30 ‚Üí lifetime", description: "Founding Voice. Lifetime perks + direct input channel to HingeCraft leadership.", bullets: ["Lifetime downloads & clubs","VIP message board to leadership","Advisory/innovation forums","Priority invitations"], accent: "from-amber-500 to-rose-500" },
    ];
    
    // Crypto minimum: $30
    const CRYPTO_MINIMUM = 30;
    
    const RAILS = [
      { key: "SOL_USDC", label: "Solana ‚Ä¢ USDC", hint: "Ultra-low fee (<$0.001)", disabled: false, isCrypto: true },
      { key: "XLM_USDC", label: "Stellar ‚Ä¢ USDC", hint: "Ultra-low fee (<$0.001)", disabled: false, isCrypto: true },
      { key: "BTC_LN", label: "Bitcoin ‚Ä¢ Lightning", hint: "Instant sats, ~1¬¢/$ multiplier", disabled: false, isCrypto: true },
      { key: "USD_CARD", label: "Card (Stripe)", hint: "Fee-included (‚âà$1.39)", isCrypto: false },
      { key: "USD_ACH", label: "ACH (Stripe)", hint: "Fee-included (‚âà$1.05)", isCrypto: false },
    ];
    
    const DEFAULT_RAIL_MULTIPLIERS = { SOL_USDC: 1.001, XLM_USDC: 1.001, BTC_LN: 1.01, CARD: 1.39, ACH: 1.05 };
    
    const formatUSD = (n) => new Intl.NumberFormat(undefined, { style: "currency", currency: "USD" }).format(Number.isFinite(n) ? n : 0);
    const minutesLeft = (iso) => { if (!iso) return 0; const t = new Date(iso).getTime(); if (!Number.isFinite(t)) return 0; const diffMs = t - Date.now(); return Math.max(0, Math.ceil(diffMs / 60000)); };
    const makeQrDataUrl = (text) => `https://chart.googleapis.com/chart?cht=qr&chs=280x280&chl=${encodeURIComponent(String(text ?? ""))}`;
    const amountForSelection = (tier, years) => (
      tier === "BASIC" ? 1
      : tier === "VIP" ? 30
      : Math.min(20, Math.max(2, Number.isFinite(years) ? years : 2))
    );
    const computeFinalAmount = (baseAmountUSD, rail, multipliers) => Math.round(baseAmountUSD * (((multipliers && multipliers[rail]) ?? DEFAULT_RAIL_MULTIPLIERS[rail] ?? 1)) * 100) / 100;
    
    const Spinner = ({ label }) => (<div className="flex items-center gap-2 mt-2"><svg className="animate-spin h-4 w-4 text-slate-600" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>{label ? <span className="text-xs text-slate-600">{label}</span> : null}</div>);
    const CopyButton = ({ text }) => { const [ok, setOk] = React.useState(false); return (<button className={`px-2 py-1 rounded border text-xs ${ok ? "border-emerald-400 text-emerald-700" : "border-slate-300"}`} onClick={async () => { try { await navigator.clipboard.writeText(String(text ?? "")); setOk(true); setTimeout(() => setOk(false), 1500);} catch {} }}>{ok ? "Copied" : "Copy"}</button>); };
    
    const StatusCard = ({ confirm, polling }) => { 
      if (!confirm) return (<div className="p-3 rounded border border-dashed"><div className="text-sm text-slate-600">Waiting for payment‚Ä¶</div>{polling ? <Spinner label="Listening for confirmations" /> : null}</div>); 
      if (confirm && confirm.status === "PENDING") return (<div className="p-3 rounded border border-amber-300 bg-amber-50"><div className="text-sm text-amber-800">Payment detected. Finalizing‚Ä¶</div><Spinner label="Confirming on network" /></div>); 
      if (confirm && confirm.status === "CONFIRMED") return (<div className="p-3 rounded border border-emerald-300 bg-emerald-50"><div className="text-sm text-emerald-800 font-semibold">Membership Activated</div><div className="mt-1 text-sm text-emerald-900">Member ID: <b>{String(confirm.memberId || "")}</b></div>{confirm.entitlement ? (<div className="mt-1 text-sm text-emerald-900">Tier: <b>{String(confirm.entitlement.tier)}</b> ¬∑ Start: {new Date(confirm.entitlement.startAt).toLocaleDateString()} ¬∑ {confirm.entitlement.endAt ? (<>End: {new Date(confirm.entitlement.endAt).toLocaleDateString()}</>) : (<>Lifetime</>)}</div>) : null}{confirm.registryHandle ? (<div className="mt-1 text-sm text-emerald-900">Registry Handle: <b>{String(confirm.registryHandle)}</b></div>) : null}<div className="mt-3 text-sm"><a className="underline" href="/dashboard">Go to Member Dashboard</a></div></div>); 
      return null; 
    };
    
    const TierCard = ({ active, onSelect, name, priceHint, description, bullets, accent, years, onYearsChange, tierKey }) => {
      // Ensure years is valid for PREMIER tier (2-20)
      const validYears = tierKey === "PREMIER" ? Math.min(20, Math.max(2, Number.isFinite(years) ? years : 2)) : years;
      
      return (
        <button 
          onClick={onSelect} 
          className={`group text-left p-5 border rounded-2xl hover:shadow transition relative overflow-hidden ${active ? "border-slate-900" : "border-slate-200"}`}
        >
          <div className={`absolute inset-0 opacity-10 bg-gradient-to-br ${accent}`} />
          <div className="relative flex flex-col h-full">
            <div className="space-y-1 leading-tight min-h-[60px]">
              <div className="text-xs uppercase tracking-wide text-slate-500">Membership Tier</div>
              <div className="text-lg font-semibold">{name}</div>
              <div className="text-sm text-slate-600">{priceHint}</div>
            </div>
            <p className="mt-2 text-sm">{description}</p>
            <ul className="mt-3 space-y-1 text-sm list-disc pl-5">
              {(bullets || []).map((b, i) => <li key={i}>{b}</li>)}
            </ul>
            <div className="mt-4 flex items-center justify-between text-slate-900 font-medium">
              <div className="inline-flex items-center gap-2">
                <span>Select</span>
                <span>‚Üí</span>
                {tierKey === "VIP" && <span>Ambassador status</span>}
              </div>
              {tierKey === "PREMIER" && (
                <div className="ml-3 w-full max-w-[200px] text-right">
                  <div className="text-lg font-semibold text-slate-900 mb-1">
                    Years 2‚Äì20: <b>{validYears}</b>
                  </div>
                  <input 
                    type="range" 
                    min={2} 
                    max={20} 
                    value={validYears} 
                    onChange={(e) => {
                      const newValue = parseInt(e.target.value, 10);
                      if (onYearsChange) {
                        onYearsChange(newValue);
                      }
                    }} 
                    className="w-full h-1 accent-black"
                    step={1}
                  />
                  <div className="text-xs text-slate-500 mt-1">${validYears} contribution</div>
                </div>
              )}
            </div>
          </div>
        </button>
      );
    };
    
    const Header = ({ onVoiceClick, view, onBack, showThankYou, onThankYou }) => (<header className="flex items-center justify-between"><div className="flex-1 min-w-0"><div className="flex items-center gap-3 flex-nowrap">{!(view === "letter" || view === "charter") && <h1 className="text-2xl sm:text-3xl font-bold">HingeCraft Global ‚Äî Membership</h1>}{!(view === "letter" || view === "charter") && (<button type="button" onClick={() => onVoiceClick && onVoiceClick()} className="inline-flex items-center gap-2 px-3 py-2 border rounded-lg text-sm leading-snug hover:shadow transition border-rose-800 text-rose-800" aria-label="Make Your Voice Heard"><strong>Make Your Voice Heard</strong></button>)}</div>{!(view === "letter" || view === "charter") && (<p className="text-slate-600 text-sm">$1 ‚Üí 1 year (Basic) ¬∑ $2‚Äì$20 ‚Üí 2‚Äì20 years (Premier) ¬∑ $30 ‚Üí Lifetime (VIP). <strong>No equity, no dividends. Membership access only.</strong></p>)}</div><div className="flex items-center gap-3">{showThankYou && (<button type="button" onClick={() => onThankYou && onThankYou()} className="inline-flex items-center gap-2 px-3 py-2 border rounded-lg text-sm leading-snug hover:shadow transition">Thank you</button>)}<button type="button" onClick={() => { try { if (view === "main") { if (window.history && window.history.length > 1) { window.history.back(); } else if (document.referrer) { window.location.href = document.referrer; } } else if (onBack) { onBack(); } else if (window.history && window.history.length > 1) { window.history.back(); } } catch (e) {} }} className="inline-flex items-center gap-1 px-3 py-2 border rounded-lg text-sm leading-snug hover:shadow transition" aria-label="Back">‚Üê Back</button></div></header>);
    
    function HingeCraftMembershipWidget({ apiBaseUrl = "", railMultipliers } = {}) {
      const [selectedTier, setSelectedTier] = useState("BASIC");
      const [years, setYears] = useState(2); // Default to 2 for PREMIER tier (2-20 range)
      const [rail, setRail] = useState("USD_CARD"); // Default to USD_CARD
      const [amount, setAmount] = useState(1);
      const [quote, setQuote] = useState(null);
      const [quoteError, setQuoteError] = useState(null);
      const [confirm, setConfirm] = useState(null);
      const [polling, setPolling] = useState(false);
      const [view, setView] = useState("main");
      const [toast, setToast] = useState("");
      const [name, setName] = useState(""); 
      const [country, setCountry] = useState(""); 
      const [cityOrg, setCityOrg] = useState(""); 
      const [oneLine, setOneLine] = useState(""); 
      const [letterText, setLetterText] = useState("");
      const [donationAmount, setDonationAmount] = useState(null);
      const [cumulativeTotal, setCumulativeTotal] = useState(0);
      const [stripe, setStripe] = useState(null);
      const [cryptoInvoice, setCryptoInvoice] = useState(null);
      const [paymentButtonUrl, setPaymentButtonUrl] = useState(null);
      const [paymentButtonText, setPaymentButtonText] = useState("Continue ‚Üí Payment");

      // Initialize page - call backend onReady
      useEffect(() => {
        // Call backend onReady function via HTTP
        async function initPage() {
          try {
            const data = await callVeloFunction(VELO_CONFIG.CHARTER_MIDDLEWARE, 'onReady', {});
            
            if (data && data.success) {
              console.log('‚úÖ Charter page initialized:', data);
              if (data.cumulativeTotal) {
                setCumulativeTotal(data.cumulativeTotal);
              }
              if (data.donationAmount) {
                setDonationAmount(data.donationAmount);
                setAmount(data.donationAmount);
                if (data.donationAmount === 1) {
                  setSelectedTier("BASIC");
                  setYears(1);
                } else if (data.donationAmount >= 2 && data.donationAmount <= 20) {
                  setSelectedTier("PREMIER");
                  setYears(data.donationAmount); // Set years to match amount (2-20)
                } else if (data.donationAmount >= 30) {
                  setSelectedTier("VIP");
                }
              }
            }
          } catch (error) {
            console.warn('‚ö†Ô∏è Error initializing page (non-blocking):', error.message);
            // Don't block page load if initialization fails
            // This is expected if functions aren't deployed yet
          }
        }

        // Get donation amount from URL, prefill token, or storage
        async function loadPrefillData() {
          const urlParams = new URLSearchParams(window.location.search);
          const prefillId = urlParams.get('prefill');
          const urlAmount = urlParams.get('donationAmount') || urlParams.get('amount');
          const urlPaymentMethod = urlParams.get('paymentMethod'); // Get payment method from URL
          const fromMissionSupport = urlParams.get('fromMissionSupport') === 'true';
          
          // Priority 1: Prefill token (from Mission Support "Other" amount)
          if (prefillId) {
            try {
              const prefillData = await callVeloFunction(VELO_CONFIG.MISSION_SUPPORT_MIDDLEWARE, 'getPrefill', { prefillId });
              if (prefillData && prefillData.success && prefillData.amount) {
                const amt = parseFloat(prefillData.amount);
                if (!isNaN(amt) && amt > 0) {
                  setDonationAmount(amt);
                  setAmount(amt);
                  // Auto-match tier and years based on amount
                  if (amt === 1) {
                    setSelectedTier("BASIC");
                    setYears(1);
                  } else if (amt >= 2 && amt <= 20) {
                    setSelectedTier("PREMIER");
                    setYears(amt); // Set years to match amount (2-20)
                  } else if (amt >= 30) {
                    setSelectedTier("VIP");
                    setYears(null); // VIP is lifetime
                  }
                  // Set payment method from URL or default to card
                  if (urlPaymentMethod) {
                    // Update rail based on payment method
                    if (urlPaymentMethod === 'crypto') {
                      setRail('SOL_USDC'); // Default to SOL for crypto
                    } else if (urlPaymentMethod === 'ACH') {
                      setRail('USD_ACH');
                    } else {
                      setRail('USD_CARD');
                    }
                  }
                  console.log('‚úÖ Prefill loaded:', amt, 'Payment method:', urlPaymentMethod);
                  return; // Exit early if prefill loaded
                }
              }
            } catch (prefillError) {
              console.warn('‚ö†Ô∏è Could not load prefill (non-blocking):', prefillError.message);
              // Fall through to URL amount
            }
          }
          
          // Priority 2: URL parameter
          if (urlAmount) {
            const amt = parseFloat(urlAmount);
            if (!isNaN(amt) && amt > 0) {
              setDonationAmount(amt);
              setAmount(amt);
              // Auto-match tier and years based on amount
              if (amt === 1) {
                setSelectedTier("BASIC");
                setYears(1);
              } else if (amt >= 2 && amt <= 20) {
                setSelectedTier("PREMIER");
                setYears(amt); // Set years to match amount (2-20)
              } else if (amt >= 30) {
                setSelectedTier("VIP");
                setYears(null); // VIP is lifetime
              }
              // Set payment method from URL
              if (urlPaymentMethod) {
                if (urlPaymentMethod === 'crypto') {
                  setRail('SOL_USDC'); // Default to SOL for crypto
                } else if (urlPaymentMethod === 'ACH' || urlPaymentMethod === 'ach') {
                  setRail('USD_ACH');
                } else {
                  setRail('USD_CARD');
                }
              } else {
                // Default to card if no payment method specified
                setRail('USD_CARD');
              }
              console.log('‚úÖ URL amount loaded:', amt, 'Payment method:', urlPaymentMethod);
              return; // Exit early if URL amount loaded
            }
          }
          
          // Priority 3: Session storage
          try {
            if (typeof sessionStorage !== 'undefined') {
              const stored = sessionStorage.getItem('hingecraft_donation');
              if (stored) {
                const data = JSON.parse(stored);
                if (data.amount) {
                  const amt = parseFloat(data.amount);
                  if (!isNaN(amt) && amt > 0) {
                    setDonationAmount(amt);
                    setAmount(amt);
                    // Auto-match tier and years
                    if (amt === 1) {
                      setSelectedTier("BASIC");
                      setYears(1);
                    } else if (amt >= 2 && amt <= 20) {
                      setSelectedTier("PREMIER");
                      setYears(amt);
                    } else if (amt >= 30) {
                      setSelectedTier("VIP");
                      setYears(null);
                    }
                    // Set payment method from stored data
                    if (data.paymentMethod) {
                      if (data.paymentMethod === 'crypto') {
                        setRail('SOL_USDC');
                      } else if (data.paymentMethod === 'ACH' || data.paymentMethod === 'ach') {
                        setRail('USD_ACH');
                      } else {
                        setRail('USD_CARD');
                      }
                    } else {
                      // Default to card if no payment method in stored data
                      setRail('USD_CARD');
                    }
                    console.log('‚úÖ Session data loaded:', amt, 'Payment method:', data.paymentMethod);
                  }
                }
              }
            }
          } catch (e) {
            console.error('Error reading session storage:', e);
          }
        }

        initPage();
        loadPrefillData();
        initStripe();
        loadCumulativeTotal();
      }, []);

      // Update payment button URL when rail (currency) changes
      useEffect(() => {
        updatePaymentButtonForRail(rail);
      }, [rail, amount, selectedTier, years]);

      // Update payment button based on selected rail/currency
      function updatePaymentButtonForRail(selectedRail) {
        const route = PAYMENT_ROUTES[selectedRail];
        if (!route) {
          setPaymentButtonUrl(null);
          setPaymentButtonText("Continue ‚Üí Payment");
          return;
        }

        // For crypto: Button will create invoice on click (URL set after invoice creation)
        if (route.type === 'crypto') {
          setPaymentButtonUrl(null); // Will be set after invoice creation
          setPaymentButtonText(`Pay with ${route.currency} ${route.type === 'crypto' ? '‚ö°' : ''}`);
        }
        
        // For Stripe: Button will create session on click (URL set after session creation)
        if (route.type === 'fiat') {
          setPaymentButtonUrl(null); // Will be set after session creation
          setPaymentButtonText(`Pay with ${route.method === 'card' ? 'Card üí≥' : 'ACH üè¶'}`);
        }
      }

      // Initialize Stripe
      async function initStripe() {
        try {
          const data = await callVeloFunction(VELO_CONFIG.STRIPE_API, 'getPublishableKey', {});
          
          if (data.success && data.publishableKey && typeof Stripe !== 'undefined') {
            setStripe(Stripe(data.publishableKey));
            console.log('‚úÖ Stripe initialized with key:', data.publishableKey.substring(0, 20) + '...');
          }
        } catch (error) {
          console.error('Error initializing Stripe:', error);
          // Don't block page load if Stripe init fails
        }
      }

      // Load cumulative total from database
      async function loadCumulativeTotal() {
        try {
          const data = await callVeloFunction(VELO_CONFIG.CHARTER_MIDDLEWARE, 'getCumulativeTotal', {});
          
          if (data.success) {
            setCumulativeTotal(data.total || 0);
          }
        } catch (error) {
          console.error('Error loading cumulative total:', error);
          // Don't block page load if this fails
        }
      }

      // Update amount when tier or years change
      useEffect(() => { 
        const newAmount = amountForSelection(selectedTier, years);
        setAmount(newAmount);
        
        // When PREMIER tier is selected, ensure years is in valid range (2-20)
        if (selectedTier === "PREMIER") {
          const validYears = Math.min(20, Math.max(2, Number.isFinite(years) ? years : 2));
          if (years !== validYears) {
            setYears(validYears);
          }
        }
        // When BASIC is selected, set years to 1
        else if (selectedTier === "BASIC") {
          setYears(1);
        }
        // When VIP is selected, years doesn't matter (lifetime)
        else if (selectedTier === "VIP") {
          // Keep years as is, but amount will be 30
        }
      }, [selectedTier, years]);
      
      const handleGoToPayment = async () => {
        // Clear any previous errors
        setQuoteError(null);
        
        // Validate rail is selected
        if (!rail) {
          setQuoteError('Please select a payment method');
          return;
        }
        
        const normalizedYears = selectedTier === "PREMIER" ? Math.min(19, Math.max(2, Number.isFinite(years) ? years : 2)) : undefined;
        const amt = Number(finalAmount.toFixed(2));
        
        console.log('üöÄ Starting payment flow:', { amount: amt, rail, tier: selectedTier });
        
        // Handle crypto payments
        if (rail === "SOL_USDC" || rail === "XLM_USDC" || rail === "BTC_LN") {
          await handleCryptoPayment(amt, rail);
          return;
        }
        
        // Handle Stripe payments (Card or ACH) - Create instant invoice
        if (rail === "USD_CARD" || rail === "USD_ACH" || rail === "CARD" || rail === "ACH") {
          await handleStripePayment(amt);
          return;
        }
        
        // Fallback: redirect to payment page
        const params = new URLSearchParams({ amount: String(amt), method: rail, tier: selectedTier });
        if (normalizedYears) params.set("years", String(normalizedYears));
        window.location.href = `${window.location.origin}/payment?${params.toString()}`;
      };

      async function handleCryptoPayment(amount, rail) {
        try {
          console.log('üí∞ Creating crypto payment:', { amount, rail });
          
          const coinMap = {
            'SOL_USDC': 'solana',
            'XLM_USDC': 'stellar',
            'BTC_LN': 'bitcoin'
          };
          const coin = coinMap[rail] || 'solana';
          
          // Use the helper function for proper error handling
          const data = await callVeloFunction(VELO_CONFIG.CHARTER_MIDDLEWARE, 'cryptoButtonClick', { amount, coin });
          
          console.log('Crypto payment response:', data);
          
          if (data.success) {
            // Store invoice data with all NOWPayments details
            const invoiceData = {
              invoiceId: data.invoiceId,
              paymentUrl: data.paymentUrl,
              payAddress: data.payAddress,
              payAmountCrypto: data.payAmountCrypto,
              payCurrency: data.payCurrency,
              expiresAt: new Date(Date.now() + 15 * 60 * 1000).toISOString()
            };
            
            setCryptoInvoice(invoiceData);
            setQuote({
              paymentRequestId: data.invoiceId,
              addressOrInvoice: data.payAddress,
              currency: data.payCurrency,
              payAmountCrypto: data.payAmountCrypto,
              expiresAt: invoiceData.expiresAt,
              paymentUrl: data.paymentUrl // NOWPayments payment URL for redirect
            });
            setPolling(true);
            
            // Update payment button URL to NOWPayments payment URL
            if (data.paymentUrl) {
              setPaymentButtonUrl(data.paymentUrl);
              setPaymentButtonText(`üí≥ Pay with NOWPayments ‚Üí`);
            }
            
            console.log('‚úÖ Crypto invoice created:', {
              invoiceId: data.invoiceId,
              paymentUrl: data.paymentUrl,
              payAddress: data.payAddress,
              payAmountCrypto: data.payAmountCrypto,
              payCurrency: data.payCurrency
            });
          } else {
            const errorMsg = data.error || 'Failed to create crypto invoice';
            console.error('‚ùå Crypto payment failed:', errorMsg);
            setQuoteError(`Failed to create crypto payment: ${errorMsg}`);
          }
        } catch (error) {
          console.error('‚ùå Crypto payment error:', error);
          setQuoteError(`Failed to create crypto payment: ${error.message || 'Please try again.'}`);
        }
      }

      async function handleStripePayment(amount) {
        try {
          console.log('üí≥ Creating Stripe instant invoice for amount:', amount, 'rail:', rail);
          
          // Determine payment method from rail
          const paymentMethod = (rail === 'USD_ACH' || rail === 'ACH') ? 'ACH' : 'card';
          
          // Create instant invoice (no email sending)
          const data = await callVeloFunction(VELO_CONFIG.CHARTER_MIDDLEWARE, 'fiatButtonClick', {
            amount: amount,
            paymentMethod: paymentMethod,
            tier: selectedTier,
            years: years
          });
          
          console.log('Stripe invoice response:', data);
          
          if (data.success && data.invoiceUrl) {
            // Invoice created instantly - redirect to payment page
            console.log('üîÑ Redirecting to Stripe invoice:', data.invoiceUrl);
            window.location.href = data.invoiceUrl;
          } else if (data.success && data.invoiceId) {
            // Invoice created but no URL - show success message with link
            setQuote({
              paymentRequestId: data.invoiceId,
              invoiceUrl: data.invoiceUrl,
              invoicePdf: data.invoicePdf,
              currency: 'USD',
              amount: amount
            });
            setPaymentButtonUrl(data.invoiceUrl);
            setPaymentButtonText(`üí≥ Pay Invoice Now ‚Üí`);
          } else {
            const errorMsg = data.error || 'Failed to create Stripe invoice';
            console.error('‚ùå Stripe error:', errorMsg);
            setQuoteError(errorMsg);
          }
        } catch (error) {
          console.error('‚ùå Stripe payment error:', error);
          setQuoteError(`Failed to create Stripe invoice: ${error.message || 'Please try again.'}`);
        }
      }

      const finalAmount = useMemo(() => computeFinalAmount(amount, rail, railMultipliers), [amount, rail, railMultipliers]);
      const multiplier = (railMultipliers && railMultipliers[rail]) ?? DEFAULT_RAIL_MULTIPLIERS[rail] ?? 1;
      
      const expired = useMemo(() => { if (!quote || !quote.expiresAt) return false; const t = new Date(quote.expiresAt).getTime(); return Number.isFinite(t) && Date.now() > t; }, [quote]);
      const backFromPayment = () => { setQuote(null); setConfirm(null); setPolling(false); setCryptoInvoice(null); setView("main"); };
      
      // Poll crypto payment status
      useEffect(() => {
        if (!polling || !cryptoInvoice) return;
        const t = setInterval(async () => {
          try {
            const data = await callVeloFunction(VELO_CONFIG.NOWPAYMENTS_API, 'getInvoiceStatus', {
              invoiceId: cryptoInvoice.invoiceId
            });
            if (!data.success) return;
            if (data.success && data.status === 'confirmed') {
              setConfirm({ status: 'CONFIRMED', memberId: cryptoInvoice.invoiceId });
              setPolling(false);
            }
            if (cryptoInvoice.expiresAt && new Date(cryptoInvoice.expiresAt).getTime() < Date.now()) {
              setPolling(false);
            }
          } catch {}
        }, 3000);
        return () => clearInterval(t);
      }, [polling, cryptoInvoice]);
      
      return (
        <div className="w-full max-w-5xl mx-auto p-4 sm:p-6 bg-white text-slate-900">
          <Header onVoiceClick={() => setView("letter")} view={view} onBack={() => setView("main")} showThankYou={view === "letter" && name.trim().length + country.trim().length + cityOrg.trim().length + oneLine.trim().length + letterText.trim().length > 0} onThankYou={() => { setView("main"); setToast("Thanks for watching."); setName(""); setCountry(""); setCityOrg(""); setOneLine(""); setLetterText(""); }} />
          
          {donationAmount && donationAmount > 0 && !quote && (
            <div className="mt-4 p-4 bg-emerald-50 border border-emerald-200 rounded-lg">
              <div className="text-sm text-emerald-800 font-semibold">Donation Amount: {formatUSD(donationAmount)}</div>
              <div className="text-xs text-emerald-700 mt-1">Amount from Mission Support form</div>
            </div>
          )}

          {cumulativeTotal > 0 && (
            <div className="mt-4 p-4 bg-slate-50 border border-slate-200 rounded-lg">
              <div className="text-sm text-slate-600">Total Contributions: <span className="font-semibold text-slate-900">{formatUSD(cumulativeTotal)}</span></div>
            </div>
          )}

          {!(view === "letter" || view === "charter") && (<>
            {!quote && (<section className="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">{TIERS.map((t) => (<TierCard key={t.key} active={selectedTier === t.key} onSelect={() => setSelectedTier(t.key)} years={years} onYearsChange={(v) => setYears(v)} tierKey={t.key} {...t} />))}</section>)}
            {!quote && (
              <div className="mt-4">
                <div className="text-sm font-medium mb-2 text-slate-700">Select Payment Method:</div>
                <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                  {RAILS.map((r) => (
                    <button 
                      key={r.key} 
                      disabled={r.disabled} 
                      onClick={() => { 
                        if (!r.disabled) {
                          console.log('Payment method selected:', r.key);
                          setRail(r.key);
                          setQuoteError(null); // Clear any previous errors
                          updatePaymentButtonForRail(r.key); // Update button immediately
                        }
                      }} 
                      className={`w-full text-left px-3 py-2 border rounded-lg transition ${
                        rail === r.key 
                          ? "border-slate-900 bg-slate-900 text-white" 
                          : "border-slate-200 hover:border-slate-400"
                      } ${r.disabled ? "opacity-50 cursor-not-allowed" : "hover:shadow cursor-pointer"}`} 
                      aria-disabled={r.disabled ? "true" : "false"}
                    >
                      <div className="font-semibold text-sm leading-snug">{r.label}</div>
                      <div className={`text-[11px] leading-snug ${rail === r.key ? "text-slate-200" : "text-slate-600"}`}>{r.hint}</div>
                    </button>
                  ))}
                </div>
              </div>
            )}
            {!quote && (
              <div className="mt-6 flex items-center justify-between gap-4">
                <div>
                  <div className="text-sm uppercase text-slate-500">Contribution</div>
                  <div className="text-2xl font-bold">{formatUSD(finalAmount)}</div>
                  {multiplier !== 1 && (
                    <div className="text-xs text-slate-500">Base {formatUSD(amount)} √ó {multiplier.toFixed(3)} (rail multiplier)</div>
                  )}
                </div>
                <div className="text-xl text-rose-800 font-medium whitespace-nowrap">Help hinge the world to craft the future.</div>
                <button 
                  onClick={handleGoToPayment} 
                  className={`px-5 py-3 rounded-lg font-semibold hover:opacity-90 transition ${
                    rail === "SOL_USDC" || rail === "XLM_USDC" || rail === "BTC_LN"
                      ? "bg-blue-600 text-white"
                      : rail === "CARD" || rail === "ACH"
                      ? "bg-purple-600 text-white"
                      : "bg-slate-900 text-white"
                  }`}
                  disabled={!rail}
                >
                  {rail === "SOL_USDC" ? "Pay with Solana ‚ö°" :
                   rail === "XLM_USDC" ? "Pay with Stellar ‚≠ê" :
                   rail === "BTC_LN" ? "Pay with Bitcoin ‚Çø" :
                   rail === "CARD" ? "Pay with Card üí≥" :
                   rail === "ACH" ? "Pay with ACH üè¶" :
                   "Continue ‚Üí Payment"}
                </button>
              </div>
            )}
            {quoteError && (<div className="mt-4 p-3 rounded bg-rose-50 text-rose-700 border border-rose-200">{String(quoteError)}</div>)}
            {quote && (<>
              <div className="mt-6 mb-2 flex items-center justify-between"><button type="button" onClick={backFromPayment} className="inline-flex items-center gap-1 px-3 py-2 border rounded-lg text-sm leading-snug hover:shadow transition" aria-label="Back to membership">‚Üê Back</button></div>
              <section className="mt-2 grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="p-4 border rounded-lg">
                  <div className="flex items-center justify-between"><h3 className="text-lg font-semibold">Send Payment</h3><span className="text-xs text-slate-500">Expires in {minutesLeft(quote && quote.expiresAt)} min</span></div>
                  <div className="mt-2 text-sm text-slate-600">Amount due: <span className="font-semibold">{formatUSD(finalAmount)}</span> {quote && quote.currency ? `(${quote.currency})` : ""}</div>
                  
                  {/* Stripe Invoice Payment Button */}
                  {quote.invoiceUrl && (
                    <div className="mt-4 mb-4">
                      <a 
                        href={quote.invoiceUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="block w-full px-6 py-4 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 text-center transition text-lg shadow-lg"
                        onClick={(e) => {
                          console.log('üîÑ Redirecting to Stripe invoice:', quote.invoiceUrl);
                          // Track redirect
                          if (typeof wixBi !== 'undefined') {
                            wixBi.track('Click', { eventName: 'Stripe Invoice Payment', paymentMethod: 'stripe' });
                          }
                        }}
                      >
                        üí≥ Pay Invoice Now ‚Üí
                      </a>
                      {quote.invoicePdf && (
                        <a 
                          href={quote.invoicePdf} 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="block w-full mt-2 px-4 py-2 bg-slate-600 text-white rounded-lg text-center transition text-sm"
                        >
                          üì• Download PDF
                        </a>
                      )}
                      <p className="mt-2 text-xs text-slate-500 text-center">Invoice created instantly. Click to complete payment on Stripe secure payment page.</p>
                    </div>
                  )}
                  
                  {/* NOWPayments Payment URL Button - Primary redirect */}
                  {quote.paymentUrl && (
                    <div className="mt-4 mb-4">
                      <a 
                        href={quote.paymentUrl} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="block w-full px-6 py-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 text-center transition text-lg shadow-lg"
                        onClick={(e) => {
                          console.log('üîÑ Redirecting to NOWPayments:', quote.paymentUrl);
                          // Track redirect
                          if (typeof wixBi !== 'undefined') {
                            wixBi.track('Click', { eventName: 'Crypto Payment Redirect', paymentMethod: quote.currency });
                          }
                        }}
                      >
                        üí≥ Pay with NOWPayments ‚Üí
                      </a>
                      <p className="mt-2 text-xs text-slate-500 text-center">Click to complete payment on NOWPayments secure payment page</p>
                    </div>
                  )}
                  
                  {/* Wallet Address and QR Code */}
                  {quote.addressOrInvoice && (
                    <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                      <div className="border rounded-lg p-3 text-xs break-all bg-slate-50">
                        <div className="text-xs font-semibold mb-2 text-slate-700">Wallet Address ({quote.currency}):</div>
                        <div className="font-mono text-[10px] leading-relaxed">{String(quote.addressOrInvoice)}</div>
                        <div className="mt-2 flex items-center gap-2">
                          <CopyButton text={quote.addressOrInvoice} />
                          <span className="text-slate-500 text-[10px]">Copy address</span>
                        </div>
                        {quote.payAmountCrypto && (
                          <div className="mt-3 p-2 bg-emerald-50 border border-emerald-200 rounded">
                            <div className="text-xs font-semibold text-emerald-800">Send exactly:</div>
                            <div className="text-sm font-bold text-emerald-900">{quote.payAmountCrypto} {quote.currency}</div>
                          </div>
                        )}
                      </div>
                      <div className="flex items-center justify-center">
                        <div className="border rounded-lg p-2 bg-white">
                          <img 
                            src={makeQrDataUrl(quote.addressOrInvoice)} 
                            alt={`${quote.currency} Payment QR Code`} 
                            className="w-48 h-48"
                          />
                          <p className="text-xs text-center mt-2 text-slate-600">Scan to pay</p>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  <div className="mt-4 text-xs text-slate-600 space-y-2">
                    {quote.paymentUrl && (
                      <p><strong>üí° Recommended:</strong> Click the "Pay with NOWPayments" button above for the easiest payment experience.</p>
                    )}
                    {quote.invoiceUrl && (
                      <p><strong>üí° Recommended:</strong> Click the "Pay Invoice Now" button above to complete your payment instantly.</p>
                    )}
                    {quote.addressOrInvoice && (
                      <p><strong>Alternative:</strong> If you prefer to pay directly from your wallet, send exactly <strong>{quote.payAmountCrypto || 'the amount shown'} {quote.currency}</strong> to the wallet address above. Your payment will be confirmed automatically.</p>
                    )}
                  </div>
                  {expired && (<div className="mt-3 p-3 rounded bg-amber-50 text-amber-800 border border-amber-200">This payment request expired. Please go back and generate a new one.</div>)}
                </div>
                <div className="p-4 border rounded-lg"><h3 className="text-lg font-semibold">Status</h3><StatusCard confirm={confirm} polling={polling} /></div>
              </section>
            </>)}
          </>)}
          {toast && <div className="mt-4 p-3 rounded bg-emerald-50 text-emerald-800 border border-emerald-200">{toast}</div>}
        </div>
      ); }
    
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<HingeCraftMembershipWidget />);
  </script>
</body>
</html>
