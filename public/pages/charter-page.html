<!DOCTYPE html>
<!--
  HingeCraft Charter Page - WITH CHECKOUT FLOW
  Flow: Payment Page ‚Üí Charter Page ‚Üí Checkout
  
  This version:
  - Displays donation amount
  - Updates contributions section
  - Provides checkout button to proceed to checkout
  - Works WITHOUT external database (uses local storage)
-->

<script>
// Charter Page Integration - WITH CHECKOUT FLOW
(function() {
  'use strict';

  const CONFIG = {
    STORAGE_KEY: 'hingecraft_donation',
    SESSION_KEY: 'hingecraft_donation',
    CHECKOUT_PAGE_URL: '/checkout' // UPDATE THIS to your checkout page URL
  };

  let donationAmount = null;

  /**
   * Get donation amount from multiple sources
   */
  function getDonationAmount() {
    // Method 1: URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const urlAmount = urlParams.get('donationAmount') || urlParams.get('amount');
    if (urlAmount) {
      const amount = parseFloat(urlAmount);
      if (!isNaN(amount) && amount > 0) {
        return amount;
      }
    }

    // Method 2: sessionStorage
    try {
      const stored = sessionStorage.getItem(CONFIG.SESSION_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        if (data.amount) {
          return parseFloat(data.amount);
        }
      }
    } catch (e) {
      console.error('Error reading sessionStorage:', e);
    }

    // Method 3: Wix Storage
    try {
      if (typeof wixStorage !== 'undefined') {
        const stored = wixStorage.getItem(CONFIG.STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          if (data.amount) {
            return parseFloat(data.amount);
          }
        }
      }
    } catch (e) {
      console.error('Error reading Wix Storage:', e);
    }

    return null;
  }

  /**
   * Update contributions section with donation amount
   * This updates the contributions section on the charter page
   */
  function updateContributionsSection(amount) {
    if (!amount || amount <= 0) return;

    const amountText = `$${amount.toFixed(2)}`;
    console.log('üîÑ Updating contributions section with amount:', amountText);

    // Method 1: Find contributions section by common selectors
    const contributionSelectors = [
      '.contribution-amount',
      '.donation-amount',
      '#contribution-amount',
      '#donation-amount',
      '[data-contribution]',
      '[data-donation]',
      '.contribution',
      '#contribution'
    ];

    contributionSelectors.forEach(selector => {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.textContent = amountText;
          el.style.color = '#10b981'; // Green color
          el.style.fontWeight = 'bold';
          console.log('‚úÖ Updated contribution element:', selector, amountText);
        });
      } catch (e) {
        // Continue
      }
    });

    // Method 2: Find "Contribution" text and update nearby amount
    const contributionLabels = document.querySelectorAll('*');
    contributionLabels.forEach(el => {
      if (el.textContent && (el.textContent.includes('Contribution') || el.textContent.includes('Donation'))) {
        // Look for amount in same element or nearby
        const parent = el.parentElement || el;
        
        // Try to find amount display
        const amountElements = parent.querySelectorAll('.amount, [data-amount], .text-2xl, .text-xl, .font-bold');
        amountElements.forEach(amountEl => {
          if (amountEl.textContent && (amountEl.textContent.includes('$') || !isNaN(parseFloat(amountEl.textContent)))) {
            amountEl.textContent = amountText;
            amountEl.style.color = '#10b981';
            amountEl.style.fontWeight = 'bold';
            console.log('‚úÖ Updated contribution amount:', amountText);
          }
        });
      }
    });

    // Method 3: Update React component state if available
    if (typeof window !== 'undefined' && window.React) {
      // Try to find React component and update state
      const reactRoot = document.getElementById('root');
      if (reactRoot && reactRoot._reactInternalInstance) {
        console.log('‚úÖ React component found, amount will be displayed');
      }
    }

    console.log('‚úÖ Contributions section update complete');
  }

  /**
   * Display donation amount prominently
   */
  function displayDonationAmount(amount) {
    // Create or update donation display
    let displayEl = document.getElementById('hingecraft-donation-display');
    
    if (!displayEl) {
      displayEl = document.createElement('div');
      displayEl.id = 'hingecraft-donation-display';
      displayEl.style.cssText = `
        background: #f0fdf4;
        border: 2px solid #10b981;
        border-radius: 8px;
        padding: 16px;
        margin: 20px 0;
        text-align: center;
        font-size: 18px;
        color: #065f46;
      `;
      
      // Insert at top of page or in contributions section
      const contributionsSection = document.querySelector('.contributions, [data-contributions], #contributions');
      if (contributionsSection) {
        contributionsSection.insertBefore(displayEl, contributionsSection.firstChild);
      } else {
        document.body.insertBefore(displayEl, document.body.firstChild);
      }
    }

    displayEl.innerHTML = `
      <div style="font-weight: bold; font-size: 24px; color: #10b981; margin-bottom: 8px;">
        Donation Amount: $${amount.toFixed(2)}
      </div>
      <div style="font-size: 14px; color: #059669;">
        Thank you for your contribution!
      </div>
    `;

    console.log('‚úÖ Donation amount displayed:', amount);
  }

  /**
   * Handle checkout button click
   */
  function handleCheckoutClick() {
    const amount = donationAmount || getDonationAmount();
    
    if (amount && amount > 0) {
      // Store amount for checkout page
      storeDonationAmount(amount);
      
      // Redirect to checkout with amount
      const checkoutUrl = `${CONFIG.CHECKOUT_PAGE_URL}?donationAmount=${encodeURIComponent(amount)}`;
      
      console.log('‚úÖ Proceeding to checkout:', checkoutUrl);
      
      if (typeof wixLocation !== 'undefined' && wixLocation.to) {
        wixLocation.to(checkoutUrl);
      } else {
        window.location.href = checkoutUrl;
      }
    } else {
      // No amount, just go to checkout
      if (typeof wixLocation !== 'undefined' && wixLocation.to) {
        wixLocation.to(CONFIG.CHECKOUT_PAGE_URL);
      } else {
        window.location.href = CONFIG.CHECKOUT_PAGE_URL;
      }
    }
  }

  /**
   * Store donation amount
   */
  function storeDonationAmount(amount) {
    try {
      if (typeof sessionStorage !== 'undefined') {
        sessionStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify({
          amount: amount,
          timestamp: new Date().toISOString(),
          source: 'charter_page'
        }));
      }

      if (typeof wixStorage !== 'undefined') {
        wixStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
          amount: amount,
          timestamp: new Date().toISOString(),
          source: 'charter_page'
        }));
      }
    } catch (e) {
      console.error('Error storing amount:', e);
    }
  }

  /**
   * Add checkout button
   */
  function addCheckoutButton() {
    // Check if button already exists
    if (document.getElementById('hingecraft-checkout-button')) {
      return;
    }

    const button = document.createElement('button');
    button.id = 'hingecraft-checkout-button';
    button.textContent = 'Proceed to Checkout';
    button.style.cssText = `
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px auto;
      display: block;
      transition: background 0.3s;
    `;

    button.addEventListener('mouseenter', function() {
      this.style.background = '#059669';
    });

    button.addEventListener('mouseleave', function() {
      this.style.background = '#10b981';
    });

    button.addEventListener('click', handleCheckoutClick);

    // Insert button after donation display or in contributions section
    const displayEl = document.getElementById('hingecraft-donation-display');
    if (displayEl) {
      displayEl.appendChild(button);
    } else {
      const contributionsSection = document.querySelector('.contributions, [data-contributions], #contributions');
      if (contributionsSection) {
        contributionsSection.appendChild(button);
      } else {
        document.body.appendChild(button);
      }
    }

    console.log('‚úÖ Checkout button added');
  }

  /**
   * T10 IMPLEMENTATION: Capture "Other Amount" and redirect to Payment Page
   * This handles the new flow: Charter Page ‚Üí Other Amount ‚Üí Payment Page (Pre-filled)
   */
  
  // Configuration for Other Amount capture
  const OTHER_AMOUNT_CONFIG = {
    PAYMENT_PAGE_URL: '/payment',
    MIN_AMOUNT: 1.00,
    MAX_AMOUNT: 25000.00,
    AMOUNT_REGEX: /^\d{1,5}(\.\d{1,2})?$/
  };

  /**
   * Validate and sanitize "Other Amount" input
   */
  function validateAndSanitizeOtherAmount(inputValue) {
    if (!inputValue || typeof inputValue !== 'string') {
      return null;
    }

    let sanitized = inputValue.trim().replace(/\s+/g, '');
    sanitized = sanitized.replace(/[$,\s]/g, '');

    if (!OTHER_AMOUNT_CONFIG.AMOUNT_REGEX.test(sanitized)) {
      return null;
    }

    const amount = parseFloat(sanitized);
    if (isNaN(amount) || amount < OTHER_AMOUNT_CONFIG.MIN_AMOUNT || amount > OTHER_AMOUNT_CONFIG.MAX_AMOUNT) {
      return null;
    }

    return Math.round(amount * 100) / 100;
  }

  /**
   * Get "Other Amount" from form input
   */
  function getOtherAmountInput() {
    const selectors = [
      '#other-amount', '#otherAmount', '#customAmount',
      'input[name="otherAmount"]', 'input[name="customAmount"]',
      'input[type="number"][placeholder*="Other" i]',
      '.other-amount-input', '.custom-amount-input',
      '[data-amount="other"]', '[data-testid="other-amount"]'
    ];

    for (const selector of selectors) {
      try {
        const element = document.querySelector(selector);
        if (element && element.value) {
          return element.value;
        }
      } catch (e) {}
    }

    if (typeof $w !== 'undefined' && $w.onReady) {
      try {
        const wixInput = $w('#otherAmount') || $w('#customAmount') || $w('#other-amount');
        if (wixInput && wixInput.value) {
          return wixInput.value;
        }
      } catch (e) {}
    }

    return null;
  }

  /**
   * Handle Other Amount form submission - Redirect to Payment Page
   */
  async function handleOtherAmountSubmit(event) {
    if (event && event.preventDefault) event.preventDefault();
    if (event && event.stopPropagation) event.stopPropagation();

    const inputValue = getOtherAmountInput();
    if (!inputValue) {
      return true; // Allow normal form submission
    }

    const validatedAmount = validateAndSanitizeOtherAmount(inputValue);
    if (!validatedAmount) {
      showErrorMessage('Please enter a valid amount between $1.00 and $25,000.00');
      return false;
    }

    // Store in session
    try {
      if (typeof sessionStorage !== 'undefined') {
        sessionStorage.setItem(CONFIG.SESSION_KEY, JSON.stringify({
          amount: validatedAmount,
          timestamp: new Date().toISOString(),
          source: 'charter_contribution_page'
        }));
      }
      if (typeof wixStorage !== 'undefined') {
        wixStorage.session.setItem(CONFIG.SESSION_KEY, JSON.stringify({
          amount: validatedAmount,
          timestamp: new Date().toISOString(),
          source: 'charter_contribution_page'
        }));
      }
    } catch (e) {
      console.error('Error storing amount:', e);
    }

    // Log to backend (non-blocking)
    try {
      if (typeof logContributionIntent !== 'undefined') {
        logContributionIntent({
          amountEntered: validatedAmount,
          timestamp: new Date().toISOString(),
          sessionID: generateSessionId(),
          anonymousFingerprint: getAnonymousFingerprint(),
          referrerSource: document.referrer || 'direct',
          pageUrl: window.location.href
        }).catch(err => console.error('Backend logging error (non-blocking):', err));
      }
    } catch (e) {
      console.error('Error logging intent:', e);
    }

    // Redirect to Payment Page with amount
    const paymentUrl = `${OTHER_AMOUNT_CONFIG.PAYMENT_PAGE_URL}?amt=${encodeURIComponent(validatedAmount)}&fromCharter=true`;
    
    if (typeof wixLocation !== 'undefined' && wixLocation.to) {
      wixLocation.to(paymentUrl);
    } else if (typeof window !== 'undefined' && window.location) {
      window.location.href = paymentUrl;
    }

    return false;
  }

  function generateSessionId() {
    try {
      if (typeof sessionStorage !== 'undefined') {
        let sessionId = sessionStorage.getItem('hingecraft_session_id');
        if (sessionId) return sessionId;
      }
      const sessionId = 'hc_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      if (typeof sessionStorage !== 'undefined') {
        sessionStorage.setItem('hingecraft_session_id', sessionId);
      }
      return sessionId;
    } catch (e) {
      return 'hc_' + Date.now();
    }
  }

  function getAnonymousFingerprint() {
    try {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('HingeCraft', 2, 2);
      return btoa(canvas.toDataURL().substring(0, 50)).substring(0, 16);
    } catch (e) {
      return 'fp_' + Math.random().toString(36).substr(2, 9);
    }
  }

  function showErrorMessage(message) {
    let errorEl = document.getElementById('hingecraft-error-message');
    if (!errorEl) {
      errorEl = document.createElement('div');
      errorEl.id = 'hingecraft-error-message';
      errorEl.style.cssText = 'background: #fee2e2; border: 2px solid #ef4444; border-radius: 8px; padding: 12px 16px; margin: 16px 0; color: #991b1b; font-size: 14px; font-weight: 500;';
      const form = document.querySelector('form') || document.body;
      form.insertBefore(errorEl, form.firstChild);
    }
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => { if (errorEl) errorEl.style.display = 'none'; }, 5000);
  }

  /**
   * Initialize charter page
   */
  function init() {
    console.log('üöÄ HingeCraft Charter Page initialized (WITH CHECKOUT FLOW + T10 OTHER AMOUNT)');

    // T10: Listen for Other Amount form submissions
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
      form.addEventListener('submit', handleOtherAmountSubmit, true);
    });

    const buttonSelectors = [
      'button[type="submit"]', 'button[data-submit="contribution"]',
      'button[data-continue="payment"]', '.submit-contribution',
      '.continue-to-payment', '[data-testid="submit-contribution"]'
    ];
    buttonSelectors.forEach(selector => {
      try {
        const buttons = document.querySelectorAll(selector);
        buttons.forEach(button => {
          button.addEventListener('click', handleOtherAmountSubmit, true);
        });
      } catch (e) {}
    });

    // Original functionality: Get donation amount from URL/session
    donationAmount = getDonationAmount();

    if (donationAmount && donationAmount > 0) {
      console.log('üí∞ Donation amount found:', donationAmount);
      displayDonationAmount(donationAmount);
      updateContributionsSection(donationAmount);
      addCheckoutButton();

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('fromPayment') === 'true') {
        console.log('‚úÖ Redirected from payment page');
      }
    } else {
      console.log('‚ÑπÔ∏è No donation amount found');
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Also initialize after delay
  setTimeout(init, 1000);

})();
</script>

