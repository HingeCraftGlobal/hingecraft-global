<!DOCTYPE html>
<!--
  HingeCraft Charter Page - WITH CRYPTO & WIX PAY INTEGRATIONS
  Features:
  - Displays donation amount
  - Shows crypto payment status
  - QR codes for crypto payments
  - Wix Pay integration
  - Complete checkout flow
-->

<script>
// Charter Page Integration - WITH CRYPTO & WIX PAY
(function() {
  'use strict';

  const CONFIG = {
    STORAGE_KEY: 'hingecraft_donation',
    SESSION_KEY: 'hingecraft_donation',
    CRYPTO_INVOICE_KEY: 'hingecraft_crypto_invoice',
    CHECKOUT_PAGE_URL: '/checkout',
    BACKEND_API: '/_functions/hingecraft.api',
    NOWPAYMENTS_API: '/_functions/nowpayments.api'
  };

  let donationAmount = null;
  let paymentMethod = null;
  let cryptoInvoiceData = null;

  /**
   * Initialize charter page
   */
  function init() {
    console.log('üöÄ HingeCraft Charter Page initialized (WITH CRYPTO & WIX PAY)');

    // Get donation amount
    donationAmount = getDonationAmount();
    
    // Get payment method
    paymentMethod = getPaymentMethod();
    
    // Get crypto invoice data if crypto payment
    if (paymentMethod === 'crypto') {
      cryptoInvoiceData = getCryptoInvoiceData();
    }

    if (donationAmount && donationAmount > 0) {
      console.log('üí∞ Donation amount found:', donationAmount);
      displayDonationAmount(donationAmount);
      updateContributionsSection(donationAmount);
      
      // Display payment method specific UI
      if (paymentMethod === 'crypto' && cryptoInvoiceData) {
        displayCryptoPaymentStatus(cryptoInvoiceData);
      } else {
        addCheckoutButton();
      }
    } else {
      console.log('‚ÑπÔ∏è No donation amount found');
    }

    // Setup crypto payment status polling if crypto payment
    if (paymentMethod === 'crypto' && cryptoInvoiceData) {
      startCryptoPaymentPolling(cryptoInvoiceData.invoiceId);
    }
  }

  /**
   * Get donation amount from multiple sources
   */
  function getDonationAmount() {
    // Method 1: URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const urlAmount = urlParams.get('donationAmount') || urlParams.get('amount');
    if (urlAmount) {
      const amount = parseFloat(urlAmount);
      if (!isNaN(amount) && amount > 0) {
        return amount;
      }
    }

    // Method 2: sessionStorage
    try {
      const stored = sessionStorage.getItem(CONFIG.SESSION_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        if (data.amount) {
          return parseFloat(data.amount);
        }
      }
    } catch (e) {
      console.error('Error reading sessionStorage:', e);
    }

    // Method 3: Wix Storage
    try {
      if (typeof wixStorage !== 'undefined') {
        const stored = wixStorage.getItem(CONFIG.STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          if (data.amount) {
            return parseFloat(data.amount);
          }
        }
      }
    } catch (e) {
      console.error('Error reading Wix Storage:', e);
    }

    return null;
  }

  /**
   * Get payment method from URL or storage
   */
  function getPaymentMethod() {
    const urlParams = new URLSearchParams(window.location.search);
    const method = urlParams.get('paymentMethod');
    if (method) return method;

    try {
      const stored = sessionStorage.getItem(CONFIG.SESSION_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        return data.paymentMethod || null;
      }
    } catch (e) {}

    return null;
  }

  /**
   * Get crypto invoice data
   */
  function getCryptoInvoiceData() {
    try {
      const stored = sessionStorage.getItem(CONFIG.CRYPTO_INVOICE_KEY);
      if (stored) {
        return JSON.parse(stored);
      }
    } catch (e) {
      console.error('Error reading crypto invoice:', e);
    }

    try {
      if (typeof wixStorage !== 'undefined') {
        const stored = wixStorage.getItem(CONFIG.CRYPTO_INVOICE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      }
    } catch (e) {}

    return null;
  }

  /**
   * Display donation amount prominently
   */
  function displayDonationAmount(amount) {
    let displayEl = document.getElementById('hingecraft-donation-display');
    
    if (!displayEl) {
      displayEl = document.createElement('div');
      displayEl.id = 'hingecraft-donation-display';
      displayEl.style.cssText = `
        background: #f0fdf4;
        border: 2px solid #10b981;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
      `;
      
      const contributionsSection = document.querySelector('.contributions, [data-contributions], #contributions');
      if (contributionsSection) {
        contributionsSection.insertBefore(displayEl, contributionsSection.firstChild);
      } else {
        document.body.insertBefore(displayEl, document.body.firstChild);
      }
    }

    displayEl.innerHTML = `
      <div style="font-weight: bold; font-size: 28px; color: #10b981; margin-bottom: 8px;">
        Donation Amount: $${amount.toFixed(2)}
      </div>
      <div style="font-size: 16px; color: #059669;">
        Thank you for your contribution!
      </div>
    `;
  }

  /**
   * Display crypto payment status
   */
  function displayCryptoPaymentStatus(invoiceData) {
    const chain = invoiceData.chain || 'crypto';
    const chainName = chain.charAt(0).toUpperCase() + chain.slice(1);
    const address = invoiceData.address || '';
    const memo = invoiceData.memo || '';
    const invoiceId = invoiceData.invoiceId || '';

    let cryptoDisplayEl = document.getElementById('hingecraft-crypto-payment-status');
    
    if (!cryptoDisplayEl) {
      cryptoDisplayEl = document.createElement('div');
      cryptoDisplayEl.id = 'hingecraft-crypto-payment-status';
      cryptoDisplayEl.style.cssText = `
        background: #fef3c7;
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      `;
      
      const displayEl = document.getElementById('hingecraft-donation-display');
      if (displayEl) {
        displayEl.appendChild(cryptoDisplayEl);
      } else {
        document.body.insertBefore(cryptoDisplayEl, document.body.firstChild);
      }
    }

    cryptoDisplayEl.innerHTML = `
      <div style="font-weight: bold; font-size: 20px; color: #92400e; margin-bottom: 16px;">
        ‚ö° Pay with ${chainName}
      </div>
      
      <div style="margin-bottom: 16px;">
        <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Wallet Address:</div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <code style="flex: 1; padding: 12px; background: white; border: 1px solid #d1d5db; border-radius: 4px; word-break: break-all; font-size: 14px;">${address}</code>
          <button id="copy-crypto-address-btn" style="padding: 12px 20px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
            Copy
          </button>
        </div>
      </div>

      ${memo ? `
      <div style="margin-bottom: 16px;">
        <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Memo:</div>
        <code style="display: block; padding: 12px; background: white; border: 1px solid #d1d5db; border-radius: 4px; word-break: break-all; font-size: 14px;">${memo}</code>
      </div>
      ` : ''}

      <div id="crypto-qr-code-container" style="text-align: center; margin: 20px 0;">
        <!-- QR code will be inserted here -->
      </div>

      <div style="padding: 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 4px; font-size: 14px; color: #1e40af; margin-top: 16px;">
        <div style="font-weight: 600; margin-bottom: 4px;">‚è≥ Payment Status: <span id="crypto-payment-status">Pending</span></div>
        <div style="font-size: 12px;">Your payment is being verified. This may take a few minutes.</div>
      </div>
    `;

    // Generate QR code
    const qrContent = address + (memo ? ':' + memo : '');
    generateQRCode(qrContent, 'crypto-qr-code-container');

    // Copy address button handler
    const copyBtn = document.getElementById('copy-crypto-address-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(address).then(() => {
          this.textContent = 'Copied!';
          setTimeout(() => {
            this.textContent = 'Copy';
          }, 2000);
        });
      });
    }
  }

  /**
   * Generate QR code
   */
  function generateQRCode(content, elementId) {
    const qrContainer = document.getElementById(elementId);
    if (!qrContainer) return;

    // Try to use qrcode.js library
    if (typeof QRCode !== 'undefined') {
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: content,
        width: 256,
        height: 256,
        colorDark: '#000000',
        colorLight: '#ffffff'
      });
    } else {
      // Fallback: Use API to generate QR code
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(content)}`;
      qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 256px; height: auto;">`;
    }
  }

  /**
   * Start polling for crypto payment status
   */
  function startCryptoPaymentPolling(invoiceId) {
    if (!invoiceId) return;

    let pollCount = 0;
    const maxPolls = 60; // Poll for 5 minutes (every 5 seconds)
    
    const pollInterval = setInterval(async () => {
      pollCount++;
      
      if (pollCount > maxPolls) {
        clearInterval(pollInterval);
        console.log('‚è±Ô∏è Polling timeout');
        return;
      }

      try {
        const status = await checkCryptoPaymentStatus(invoiceId);
        
        if (status === 'paid' || status === 'confirmed') {
          clearInterval(pollInterval);
          updateCryptoPaymentStatus('confirmed', 'Payment confirmed! Thank you.');
          
          // Redirect to success page after delay
          setTimeout(() => {
            redirectToSuccess();
          }, 2000);
        } else if (status === 'failed' || status === 'expired') {
          clearInterval(pollInterval);
          updateCryptoPaymentStatus('failed', 'Payment failed or expired. Please try again.');
        } else {
          updateCryptoPaymentStatus('pending', 'Waiting for payment confirmation...');
        }
      } catch (error) {
        console.error('Error checking payment status:', error);
      }
    }, 5000); // Poll every 5 seconds
  }

  /**
   * Check crypto payment status
   */
  async function checkCryptoPaymentStatus(invoiceId) {
    try {
      const response = await wixFetch.fetch(`${CONFIG.NOWPAYMENTS_API}/getInvoiceStatus`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ invoiceId })
      });

      if (!response.ok) {
        throw new Error(`Status check failed: ${response.status}`);
      }

      const data = await response.json();
      return data.status || 'pending';
    } catch (error) {
      console.error('Error checking payment status:', error);
      return 'pending';
    }
  }

  /**
   * Update crypto payment status display
   */
  function updateCryptoPaymentStatus(status, message) {
    const statusEl = document.getElementById('crypto-payment-status');
    if (statusEl) {
      statusEl.textContent = message;
      
      if (status === 'confirmed') {
        statusEl.style.color = '#10b981';
        statusEl.parentElement.parentElement.style.background = '#d1fae5';
        statusEl.parentElement.parentElement.style.borderColor = '#10b981';
      } else if (status === 'failed') {
        statusEl.style.color = '#ef4444';
        statusEl.parentElement.parentElement.style.background = '#fee2e2';
        statusEl.parentElement.parentElement.style.borderColor = '#ef4444';
      }
    }
  }

  /**
   * Update contributions section
   */
  function updateContributionsSection(amount) {
    if (!amount || amount <= 0) return;

    const amountText = `$${amount.toFixed(2)}`;
    const contributionSelectors = [
      '.contribution-amount', '.donation-amount',
      '#contribution-amount', '#donation-amount',
      '[data-contribution]', '[data-donation]'
    ];

    contributionSelectors.forEach(selector => {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.textContent = amountText;
          el.style.color = '#10b981';
          el.style.fontWeight = 'bold';
        });
      } catch (e) {}
    });
  }

  /**
   * Add checkout button
   */
  function addCheckoutButton() {
    if (document.getElementById('hingecraft-checkout-button')) {
      return;
    }

    const button = document.createElement('button');
    button.id = 'hingecraft-checkout-button';
    button.textContent = 'Proceed to Checkout';
    button.style.cssText = `
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px auto;
      display: block;
      transition: background 0.3s;
    `;

    button.addEventListener('mouseenter', function() {
      this.style.background = '#059669';
    });

    button.addEventListener('mouseleave', function() {
      this.style.background = '#10b981';
    });

    button.addEventListener('click', handleCheckoutClick);

    const displayEl = document.getElementById('hingecraft-donation-display');
    if (displayEl) {
      displayEl.appendChild(button);
    } else {
      document.body.appendChild(button);
    }
  }

  /**
   * Handle checkout button click
   */
  function handleCheckoutClick() {
    const amount = donationAmount || getDonationAmount();
    
    if (amount && amount > 0) {
      const checkoutUrl = `${CONFIG.CHECKOUT_PAGE_URL}?donationAmount=${encodeURIComponent(amount)}`;
      
      if (typeof wixLocation !== 'undefined' && wixLocation.to) {
        wixLocation.to(checkoutUrl);
      } else {
        window.location.href = checkoutUrl;
      }
    } else {
      if (typeof wixLocation !== 'undefined' && wixLocation.to) {
        wixLocation.to(CONFIG.CHECKOUT_PAGE_URL);
      } else {
        window.location.href = CONFIG.CHECKOUT_PAGE_URL;
      }
    }
  }

  /**
   * Redirect to success page
   */
  function redirectToSuccess() {
    const successUrl = `/payment-success?amount=${donationAmount}&method=${paymentMethod}`;
    
    if (typeof wixLocation !== 'undefined' && wixLocation.to) {
      wixLocation.to(successUrl);
    } else {
      window.location.href = successUrl;
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  setTimeout(init, 1000);

})();
</script>

