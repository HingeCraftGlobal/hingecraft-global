<!DOCTYPE html>
<!--
  HingeCraft Charter Page - WITH STRIPE & CRYPTO INTEGRATIONS
  Features:
  - Stripe payment button (card payments)
  - Crypto payment options (Solana, Stellar, Bitcoin, Ethereum)
  - NOWPayments API integration
  - Complete payment flow
  - Payment status polling
-->

<script src="https://js.stripe.com/v3/"></script>
<script>
// Charter Page Integration - WITH STRIPE & CRYPTO
(function() {
  'use strict';

  const CONFIG = {
    STORAGE_KEY: 'hingecraft_donation',
    SESSION_KEY: 'hingecraft_donation',
    CRYPTO_INVOICE_KEY: 'hingecraft_crypto_invoice',
    CHECKOUT_PAGE_URL: '/checkout',
    BACKEND_API: '/_functions/hingecraft.api',
    NOWPAYMENTS_API: '/_functions/nowpayments.api',
    STRIPE_API: '/_functions/stripe.api'
  };

  let donationAmount = null;
  let paymentMethod = null;
  let cryptoInvoiceData = null;
  let stripe = null;

  /**
   * Initialize Stripe
   */
  async function initStripe() {
    try {
      // Get publishable key from backend
      const response = await fetch(CONFIG.STRIPE_API + '/getPublishableKey');
      const data = await response.json();
      
      if (data.success && data.publishableKey) {
        stripe = Stripe(data.publishableKey);
        console.log('‚úÖ Stripe initialized');
      } else {
        console.warn('‚ö†Ô∏è  Could not initialize Stripe:', data.error);
      }
    } catch (error) {
      console.error('‚ùå Error initializing Stripe:', error);
    }
  }

  /**
   * Initialize charter page
   */
  async function init() {
    console.log('üöÄ HingeCraft Charter Page initialized (WITH STRIPE & CRYPTO)');

    // Initialize Stripe
    await initStripe();

    // Get donation amount
    donationAmount = getDonationAmount();
    
    // Get payment method
    paymentMethod = getPaymentMethod();
    
    // Get crypto invoice data if crypto payment
    if (paymentMethod === 'crypto') {
      cryptoInvoiceData = getCryptoInvoiceData();
    }

    if (donationAmount && donationAmount > 0) {
      console.log('üí∞ Donation amount found:', donationAmount);
      displayDonationAmount(donationAmount);
      updateContributionsSection(donationAmount);
      
      // Display payment method specific UI
      if (paymentMethod === 'crypto' && cryptoInvoiceData) {
        displayCryptoPaymentStatus(cryptoInvoiceData);
      } else {
        // Show payment options (Stripe + Crypto)
        addPaymentOptions(donationAmount);
      }
    } else {
      console.log('‚ÑπÔ∏è No donation amount found');
    }

    // Setup crypto payment status polling if crypto payment
    if (paymentMethod === 'crypto' && cryptoInvoiceData) {
      startCryptoPaymentPolling(cryptoInvoiceData.invoiceId);
    }
  }

  /**
   * Add payment options (Stripe + Crypto)
   */
  function addPaymentOptions(amount) {
    if (document.getElementById('hingecraft-payment-options')) {
      return;
    }

    const paymentContainer = document.createElement('div');
    paymentContainer.id = 'hingecraft-payment-options';
    paymentContainer.style.cssText = `
      margin: 20px 0;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    `;

    paymentContainer.innerHTML = `
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-weight: bold; font-size: 20px; color: #111827; margin-bottom: 12px;">
          Complete Your Donation
        </div>
        <div style="font-size: 16px; color: #6b7280; margin-bottom: 20px;">
          Choose your payment method
        </div>
      </div>

      <!-- Stripe Payment Button -->
      ${stripe ? `
      <div style="margin-bottom: 16px;">
        <button id="hingecraft-stripe-button" style="
          width: 100%;
          background: #635BFF;
          color: white;
          border: none;
          border-radius: 8px;
          padding: 16px 32px;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: background 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        ">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 12H20M4 6H20M4 18H20" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Pay $${amount.toFixed(2)} with Stripe
        </button>
      </div>
      ` : ''}

      <!-- Crypto Payment Options -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
        <div style="font-weight: 600; margin-bottom: 12px; color: #374151; text-align: center;">
          Or pay with cryptocurrency:
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          <button class="crypto-payment-btn" data-chain="solana" style="
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
          ">
            ‚ö° Solana (SOL)
          </button>
          <button class="crypto-payment-btn" data-chain="stellar" style="
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
          ">
            ‚≠ê Stellar (XLM)
          </button>
          <button class="crypto-payment-btn" data-chain="bitcoin" style="
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
          ">
            ‚Çø Bitcoin (BTC)
          </button>
          <button class="crypto-payment-btn" data-chain="ethereum" style="
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
          ">
            Œû Ethereum (ETH)
          </button>
        </div>
      </div>
    `;

    const displayEl = document.getElementById('hingecraft-donation-display');
    if (displayEl) {
      displayEl.appendChild(paymentContainer);
    } else {
      document.body.appendChild(paymentContainer);
    }

    // Add Stripe button handler
    if (stripe) {
      const stripeButton = document.getElementById('hingecraft-stripe-button');
      if (stripeButton) {
        stripeButton.addEventListener('mouseenter', function() {
          this.style.background = '#0A2540';
        });
        stripeButton.addEventListener('mouseleave', function() {
          this.style.background = '#635BFF';
        });
        stripeButton.addEventListener('click', function() {
          handleStripePayment(amount);
        });
      }
    }

    // Add crypto button handlers
    const cryptoButtons = document.querySelectorAll('.crypto-payment-btn');
    cryptoButtons.forEach(button => {
      button.addEventListener('mouseenter', function() {
        this.style.borderColor = '#10b981';
        this.style.background = '#f0fdf4';
      });
      button.addEventListener('mouseleave', function() {
        this.style.borderColor = '#e5e7eb';
        this.style.background = 'white';
      });
      button.addEventListener('click', function() {
        const chain = this.getAttribute('data-chain');
        handleCryptoPayment(amount, chain);
      });
    });
  }

  /**
   * Handle Stripe payment
   */
  async function handleStripePayment(amount) {
    if (!stripe) {
      showError('Stripe is not initialized. Please refresh the page.');
      return;
    }

    try {
      console.log('üí≥ Creating Stripe checkout session...');

      const button = document.getElementById('hingecraft-stripe-button');
      const originalText = button.innerHTML;
      button.innerHTML = '‚è≥ Processing...';
      button.disabled = true;

      // Create checkout session
      const response = await fetch(CONFIG.STRIPE_API + '/createCheckoutSession', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          amount: amount,
          successUrl: window.location.origin + '/payment-success?amount=' + amount + '&method=stripe',
          cancelUrl: window.location.origin + '/charter?canceled=true&amount=' + amount
        })
      });

      if (!response.ok) {
        throw new Error('Failed to create checkout session');
      }

      const session = await response.json();

      if (!session.success) {
        throw new Error(session.error || 'Failed to create checkout session');
      }

      // Redirect to Stripe Checkout
      const result = await stripe.redirectToCheckout({
        sessionId: session.sessionId
      });

      if (result.error) {
        throw new Error(result.error.message);
      }

    } catch (error) {
      console.error('‚ùå Stripe payment error:', error);
      showError('Payment failed. Please try again.');
      
      const button = document.getElementById('hingecraft-stripe-button');
      if (button) {
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }
  }

  /**
   * Handle crypto payment
   */
  async function handleCryptoPayment(amount, chain) {
    try {
      console.log('üí∞ Creating crypto invoice:', { amount, chain });

      // Create NOWPayments invoice
      const response = await fetch(CONFIG.NOWPAYMENTS_API + '/createInvoice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          amount: amount,
          currency: 'USD',
          payCurrency: chain.toUpperCase(),
          orderId: `HC-${Date.now()}`,
          orderDescription: `HingeCraft Donation - $${amount}`,
          successUrl: window.location.origin + '/payment-success?amount=' + amount + '&method=crypto&chain=' + chain,
          cancelUrl: window.location.origin + '/charter?canceled=true&amount=' + amount
        })
      });

      if (!response.ok) {
        throw new Error('Failed to create crypto invoice');
      }

      const invoiceData = await response.json();

      // Store invoice data
      cryptoInvoiceData = invoiceData;
      storeCryptoInvoice(invoiceData);

      // Hide payment options and show crypto payment display
      const paymentOptions = document.getElementById('hingecraft-payment-options');
      if (paymentOptions) {
        paymentOptions.style.display = 'none';
      }

      // Display crypto payment status
      displayCryptoPaymentStatus({
        chain: chain,
        address: invoiceData.payAddress || invoiceData.address,
        memo: invoiceData.memo || '',
        invoiceId: invoiceData.invoiceId || invoiceData.id
      });

      // Start polling
      startCryptoPaymentPolling(invoiceData.invoiceId || invoiceData.id);

    } catch (error) {
      console.error('‚ùå Crypto payment error:', error);
      showError('Failed to create crypto payment. Please try again.');
    }
  }

  /**
   * Get donation amount from multiple sources
   */
  function getDonationAmount() {
    const urlParams = new URLSearchParams(window.location.search);
    const urlAmount = urlParams.get('donationAmount') || urlParams.get('amount');
    if (urlAmount) {
      const amount = parseFloat(urlAmount);
      if (!isNaN(amount) && amount > 0) {
        return amount;
      }
    }

    try {
      const stored = sessionStorage.getItem(CONFIG.SESSION_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        if (data.amount) {
          return parseFloat(data.amount);
        }
      }
    } catch (e) {}

    try {
      if (typeof wixStorage !== 'undefined') {
        const stored = wixStorage.getItem(CONFIG.STORAGE_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          if (data.amount) {
            return parseFloat(data.amount);
          }
        }
      }
    } catch (e) {}

    return null;
  }

  /**
   * Get payment method from URL or storage
   */
  function getPaymentMethod() {
    const urlParams = new URLSearchParams(window.location.search);
    const method = urlParams.get('paymentMethod');
    if (method) return method;

    try {
      const stored = sessionStorage.getItem(CONFIG.SESSION_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        return data.paymentMethod || null;
      }
    } catch (e) {}

    return null;
  }

  /**
   * Get crypto invoice data
   */
  function getCryptoInvoiceData() {
    try {
      const stored = sessionStorage.getItem(CONFIG.CRYPTO_INVOICE_KEY);
      if (stored) {
        return JSON.parse(stored);
      }
    } catch (e) {}

    try {
      if (typeof wixStorage !== 'undefined') {
        const stored = wixStorage.getItem(CONFIG.CRYPTO_INVOICE_KEY);
        if (stored) {
          return JSON.parse(stored);
        }
      }
    } catch (e) {}

    return null;
  }

  /**
   * Store crypto invoice data
   */
  function storeCryptoInvoice(invoiceData) {
    try {
      const data = {
        invoiceId: invoiceData.invoiceId || invoiceData.id,
        amount: donationAmount,
        chain: invoiceData.chain,
        address: invoiceData.payAddress || invoiceData.address,
        memo: invoiceData.memo,
        timestamp: new Date().toISOString()
      };

      if (typeof sessionStorage !== 'undefined') {
        sessionStorage.setItem(CONFIG.CRYPTO_INVOICE_KEY, JSON.stringify(data));
      }

      if (typeof wixStorage !== 'undefined') {
        wixStorage.setItem(CONFIG.CRYPTO_INVOICE_KEY, JSON.stringify(data));
      }
    } catch (error) {
      console.error('Error storing crypto invoice:', error);
    }
  }

  /**
   * Display donation amount prominently
   */
  function displayDonationAmount(amount) {
    let displayEl = document.getElementById('hingecraft-donation-display');
    
    if (!displayEl) {
      displayEl = document.createElement('div');
      displayEl.id = 'hingecraft-donation-display';
      displayEl.style.cssText = `
        background: #f0fdf4;
        border: 2px solid #10b981;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        text-align: center;
      `;
      
      const contributionsSection = document.querySelector('.contributions, [data-contributions], #contributions');
      if (contributionsSection) {
        contributionsSection.insertBefore(displayEl, contributionsSection.firstChild);
      } else {
        document.body.insertBefore(displayEl, document.body.firstChild);
      }
    }

    displayEl.innerHTML = `
      <div style="font-weight: bold; font-size: 28px; color: #10b981; margin-bottom: 8px;">
        Donation Amount: $${amount.toFixed(2)}
      </div>
      <div style="font-size: 16px; color: #059669;">
        Thank you for your contribution!
      </div>
    `;
  }

  /**
   * Display crypto payment status
   */
  function displayCryptoPaymentStatus(invoiceData) {
    const chain = invoiceData.chain || 'crypto';
    const chainName = chain.charAt(0).toUpperCase() + chain.slice(1);
    const address = invoiceData.address || '';
    const memo = invoiceData.memo || '';

    let cryptoDisplayEl = document.getElementById('hingecraft-crypto-payment-status');
    
    if (!cryptoDisplayEl) {
      cryptoDisplayEl = document.createElement('div');
      cryptoDisplayEl.id = 'hingecraft-crypto-payment-status';
      cryptoDisplayEl.style.cssText = `
        background: #fef3c7;
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      `;
      
      const displayEl = document.getElementById('hingecraft-donation-display');
      if (displayEl) {
        displayEl.appendChild(cryptoDisplayEl);
      } else {
        document.body.insertBefore(cryptoDisplayEl, document.body.firstChild);
      }
    }

    cryptoDisplayEl.innerHTML = `
      <div style="font-weight: bold; font-size: 20px; color: #92400e; margin-bottom: 16px;">
        ‚ö° Pay with ${chainName}
      </div>
      
      <div style="margin-bottom: 16px;">
        <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Wallet Address:</div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <code style="flex: 1; padding: 12px; background: white; border: 1px solid #d1d5db; border-radius: 4px; word-break: break-all; font-size: 14px;">${address}</code>
          <button id="copy-crypto-address-btn" style="padding: 12px 20px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
            Copy
          </button>
        </div>
      </div>

      ${memo ? `
      <div style="margin-bottom: 16px;">
        <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">Memo:</div>
        <code style="display: block; padding: 12px; background: white; border: 1px solid #d1d5db; border-radius: 4px; word-break: break-all; font-size: 14px;">${memo}</code>
      </div>
      ` : ''}

      <div id="crypto-qr-code-container" style="text-align: center; margin: 20px 0;">
        <!-- QR code will be inserted here -->
      </div>

      <div style="padding: 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 4px; font-size: 14px; color: #1e40af; margin-top: 16px;">
        <div style="font-weight: 600; margin-bottom: 4px;">‚è≥ Payment Status: <span id="crypto-payment-status">Pending</span></div>
        <div style="font-size: 12px;">Your payment is being verified. This may take a few minutes.</div>
      </div>
    `;

    // Generate QR code
    const qrContent = address + (memo ? ':' + memo : '');
    generateQRCode(qrContent, 'crypto-qr-code-container');

    // Copy address button handler
    const copyBtn = document.getElementById('copy-crypto-address-btn');
    if (copyBtn) {
      copyBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(address).then(() => {
          this.textContent = 'Copied!';
          setTimeout(() => {
            this.textContent = 'Copy';
          }, 2000);
        });
      });
    }
  }

  /**
   * Generate QR code
   */
  function generateQRCode(content, elementId) {
    const qrContainer = document.getElementById(elementId);
    if (!qrContainer) return;

    if (typeof QRCode !== 'undefined') {
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: content,
        width: 256,
        height: 256,
        colorDark: '#000000',
        colorLight: '#ffffff'
      });
    } else {
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodeURIComponent(content)}`;
      qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="max-width: 256px; height: auto;">`;
    }
  }

  /**
   * Start polling for crypto payment status
   */
  function startCryptoPaymentPolling(invoiceId) {
    if (!invoiceId) return;

    let pollCount = 0;
    const maxPolls = 60;
    
    const pollInterval = setInterval(async () => {
      pollCount++;
      
      if (pollCount > maxPolls) {
        clearInterval(pollInterval);
        return;
      }

      try {
        const status = await checkCryptoPaymentStatus(invoiceId);
        
        if (status === 'paid' || status === 'confirmed') {
          clearInterval(pollInterval);
          updateCryptoPaymentStatus('confirmed', 'Payment confirmed! Thank you.');
          setTimeout(() => {
            redirectToSuccess();
          }, 2000);
        } else if (status === 'failed' || status === 'expired') {
          clearInterval(pollInterval);
          updateCryptoPaymentStatus('failed', 'Payment failed or expired. Please try again.');
        } else {
          updateCryptoPaymentStatus('pending', 'Waiting for payment confirmation...');
        }
      } catch (error) {
        console.error('Error checking payment status:', error);
      }
    }, 5000);
  }

  /**
   * Check crypto payment status
   */
  async function checkCryptoPaymentStatus(invoiceId) {
    try {
      const response = await wixFetch.fetch(`${CONFIG.NOWPAYMENTS_API}/getInvoiceStatus`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ invoiceId })
      });

      if (!response.ok) {
        throw new Error(`Status check failed: ${response.status}`);
      }

      const data = await response.json();
      return data.status || 'pending';
    } catch (error) {
      console.error('Error checking payment status:', error);
      return 'pending';
    }
  }

  /**
   * Update crypto payment status display
   */
  function updateCryptoPaymentStatus(status, message) {
    const statusEl = document.getElementById('crypto-payment-status');
    if (statusEl) {
      statusEl.textContent = message;
      
      if (status === 'confirmed') {
        statusEl.style.color = '#10b981';
        statusEl.parentElement.parentElement.style.background = '#d1fae5';
        statusEl.parentElement.parentElement.style.borderColor = '#10b981';
      } else if (status === 'failed') {
        statusEl.style.color = '#ef4444';
        statusEl.parentElement.parentElement.style.background = '#fee2e2';
        statusEl.parentElement.parentElement.style.borderColor = '#ef4444';
      }
    }
  }

  /**
   * Update contributions section
   */
  function updateContributionsSection(amount) {
    if (!amount || amount <= 0) return;

    const amountText = `$${amount.toFixed(2)}`;
    const contributionSelectors = [
      '.contribution-amount', '.donation-amount',
      '#contribution-amount', '#donation-amount',
      '[data-contribution]', '[data-donation]'
    ];

    contributionSelectors.forEach(selector => {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach(el => {
          el.textContent = amountText;
          el.style.color = '#10b981';
          el.style.fontWeight = 'bold';
        });
      } catch (e) {}
    });
  }

  /**
   * Show error message
   */
  function showError(message) {
    let errorEl = document.getElementById('hingecraft-error-message');
    if (!errorEl) {
      errorEl = document.createElement('div');
      errorEl.id = 'hingecraft-error-message';
      errorEl.style.cssText = `
        background: #fee2e2;
        border: 2px solid #ef4444;
        border-radius: 8px;
        padding: 12px 16px;
        margin: 16px 0;
        color: #991b1b;
        font-size: 14px;
        font-weight: 500;
      `;
      document.body.insertBefore(errorEl, document.body.firstChild);
    }
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => {
      if (errorEl) errorEl.style.display = 'none';
    }, 5000);
  }

  /**
   * Redirect to success page
   */
  function redirectToSuccess() {
    const successUrl = `/payment-success?amount=${donationAmount}&method=${paymentMethod}`;
    
    if (typeof wixLocation !== 'undefined' && wixLocation.to) {
      wixLocation.to(successUrl);
    } else {
      window.location.href = successUrl;
    }
  }

  // Initialize
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  setTimeout(init, 1000);

})();
</script>

